<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mersin İli THA Sistemi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Chart.js Datalabels Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .table-container {
            max-height: 60vh;
            overflow-y: auto;
            overflow-x: auto;
        }
        .table-container::-webkit-scrollbar { width: 8px; height: 8px; }
        .table-container::-webkit-scrollbar-track { background: #f1f1f1; }
        .table-container::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        .table-container::-webkit-scrollbar-thumb:hover { background: #555; }
        th .sort-icon { opacity: 0.3; transition: opacity 0.2s; }
        th:hover .sort-icon { opacity: 0.7; }
        th .sort-icon.active { opacity: 1; color: #2563eb; }
        .tab-btn {
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        .tab-btn.active {
            color: #2563eb;
            border-bottom-color: #2563eb;
        }
        #task-table tr {
            cursor: pointer;
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Login Screen -->
    <div id="login-screen" class="flex items-center justify-center min-h-screen bg-gradient-to-br from-blue-100 to-gray-100">
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-xl shadow-2xl">
            <h2 class="text-3xl font-bold text-center text-gray-700">THA SİSTEMİ</h2>
            <p class="text-center text-gray-500">Devam etmek için lütfen giriş yapın.</p>
            <form id="login-form" class="space-y-6">
                <div>
                    <input id="username" type="text" required class="w-full px-4 py-2 text-gray-700 bg-gray-100 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Kullanıcı Adı">
                </div>
                <div>
                    <input id="password" type="password" required class="w-full px-4 py-2 text-gray-700 bg-gray-100 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Şifre">
                </div>
                <div id="error-message" class="text-red-500 text-sm text-center hidden">Hatalı kullanıcı adı veya şifre.</div>
                <div>
                    <button type="submit" class="w-full px-4 py-2 font-bold text-white bg-green-600 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50">
                        Giriş Yap
                    </button>
                </div>
            </form>
             <p class="text-center text-xs text-gray-400">© Gökhan ELGÜL tarafından tasarlanmıştır.</p>
        </div>
    </div>

    <!-- Main Application -->
    <div id="main-app" class="hidden">
        <div class="bg-white shadow-md">
            <nav class="container mx-auto flex">
                <button id="analiz-tab-btn" class="tab-btn active">THA Analizi</button>
                <button id="takip-tab-btn" class="tab-btn">İş Takip</button>
            </nav>
        </div>

        <!-- THA Analiz Page -->
        <div id="analiz-page" class="container mx-auto p-4 md:p-8">
            <header class="text-center mb-8">
                <h1 class="text-3xl md:text-4xl font-bold text-gray-700">MERSİN İLİ THA ANALİZİ</h1>
                <p class="text-gray-500 mt-2">İlçe seçerek arazi niteliklerini arayın, filtreleyin ve özet bilgileri görüntüleyin.</p>
            </header>
            <div class="mb-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-6 items-end">
                 <div class="bg-white p-4 rounded-xl shadow-md"><label for="ilce-select" class="block text-sm font-medium text-gray-600 mb-2">İlçe Seçin:</label><select id="ilce-select" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition" disabled></select></div>
                 <div class="bg-white p-4 rounded-xl shadow-md"><label for="search-input" class="block text-sm font-medium text-gray-600 mb-2">Nitelik Ara:</label><input type="text" id="search-input" placeholder="Örn: Orman..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition" disabled></div>
                 <div class="sm:col-span-1 bg-white p-4 rounded-xl shadow-md flex flex-col justify-center text-center"><h3 class="text-lg font-semibold text-blue-600">Seçili Alan Dağılımı</h3><div class="mt-2"><span class="text-sm text-green-600">Ekonomik Değeri Olan</span><p id="ekonomik-var-ilce-toplam" class="text-xl font-bold text-gray-800">0 m²</p></div><div class="mt-2 border-t pt-2"><span class="text-sm text-red-600">Ekonomik Değeri Olmayan</span><p id="ekonomik-yok-ilce-toplam" class="text-xl font-bold text-gray-800">0 m²</p></div></div>
                 <div class="sm:col-span-1 bg-white p-4 rounded-xl shadow-md flex flex-col justify-center text-center"><h3 id="toplam-kart-baslik" class="text-lg font-semibold text-indigo-600">Mersin Genel Toplam</h3><p id="genel-toplam" class="text-2xl font-bold text-gray-800 mt-2">0 m²</p></div>
                 <div class="sm:col-span-2 lg:col-span-1 bg-white p-4 rounded-xl shadow-md flex flex-col justify-center text-center space-y-2"><button id="toggle-chart" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700" disabled>Grafikleri Göster/Gizle</button><button id="download-excel" class="w-full bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700" disabled>Excel Olarak İndir</button></div>
            </div>
            <div id="chart-container" class="bg-white rounded-xl shadow-md p-4 mb-6 hidden"><div class="grid grid-cols-1 lg:grid-cols-2 gap-6 items-center"><div class="relative h-96"><h2 class="text-xl font-bold text-center text-gray-700 mb-4">Nitelik Bazlı Alan Dağılımı</h2><canvas id="nitelikBarChart"></canvas></div><div class="relative h-96"><h2 class="text-xl font-bold text-center text-gray-700 mb-4">İlçe Bazlı Karşılaştırma</h2><canvas id="ilceBarChart"></canvas></div></div></div>
            <div class="bg-white rounded-xl shadow-md overflow-hidden"><div class="table-container"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-100 sticky top-0"><tr><th class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Nitelik</th><th class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Kod</th><th class="px-6 py-3 text-right text-xs font-bold text-gray-600 uppercase tracking-wider cursor-pointer" data-sort-by="adet"><div class="flex items-center justify-end"><span>Adet</span><svg class="w-4 h-4 ml-1 sort-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8 9l4-4 4 4m0 6l-4 4-4-4"></path></svg></div></th><th class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider cursor-pointer" data-sort-by="ekonomikDegeri"><div class="flex items-center"><span>Ekonomik Değeri</span><svg class="w-4 h-4 ml-1 sort-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8 9l4-4 4 4m0 6l-4 4-4-4"></path></svg></div></th><th class="px-6 py-3 text-right text-xs font-bold text-gray-600 uppercase tracking-wider cursor-pointer" data-sort-by="yuzolcumM2"><div class="flex items-center justify-end"><span>Yüzölçüm (m²)</span><svg class="w-4 h-4 ml-1 sort-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8 9l4-4 4 4m0 6l-4 4-4-4"></path></svg></div></th><th class="px-6 py-3 text-right text-xs font-bold text-gray-600 uppercase tracking-wider cursor-pointer" data-sort-by="yuzolcumHa"><div class="flex items-center justify-end"><span>Yüzölçüm (ha)</span><svg class="w-4 h-4 ml-1 sort-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8 9l4-4 4 4m0 6l-4 4-4-4"></path></svg></div></th></tr></thead><tbody id="data-table" class="bg-white divide-y divide-gray-200"><tr><td colspan="6" class="px-6 py-12 text-center text-gray-500"><div id="loading-state-analiz">Veriler yükleniyor...</div></td></tr></tbody></table></div></div>
        </div>
        
        <!-- İş Takip Page -->
        <div id="takip-page" class="container mx-auto p-4 md:p-8 hidden">
             <header class="text-center mb-8">
                <h1 class="text-3xl md:text-4xl font-bold text-gray-800">THA İŞ TAKİP SİSTEMİ</h1>
                <p class="text-gray-600 mt-2">Personel bazlı MEGSİS ve NETİGMA giriş takibi.</p>
            </header>
            <div class="mb-6 grid grid-cols-1 md:grid-cols-4 gap-6 items-end">
                <div class="bg-white p-4 rounded-xl shadow"><label for="takip-ilce-filter" class="block text-sm font-medium text-gray-700">İlçeye Göre Filtrele</label><select id="takip-ilce-filter" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></select></div>
                <div class="bg-white p-4 rounded-xl shadow"><label for="takip-mahalle-filter" class="block text-sm font-medium text-gray-700">Mahalleye Göre Filtrele</label><select id="takip-mahalle-filter" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></select></div>
                <div class="bg-white p-4 rounded-xl shadow"><label for="takip-personel-filter" class="block text-sm font-medium text-gray-700">Personele Göre Filtrele</label><select id="takip-personel-filter" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></select></div>
                 <div class="bg-white p-4 rounded-xl shadow flex flex-col space-y-2">
                    <button id="add-entry-btn" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Yeni Giriş Ekle</button>
                    <button id="download-takip-excel-btn" class="w-full bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">Tabloyu İndir</button>
                </div>
            </div>
            <div class="mb-6 bg-white p-4 rounded-xl shadow">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-700">Personel Giriş Sayıları</h2>
                    <button id="download-chart-btn" class="bg-gray-200 text-gray-700 font-bold py-1 px-3 rounded-lg hover:bg-gray-300 text-sm">Grafiği İndir</button>
                </div>
                <div class="relative h-96"><canvas id="personelChart"></canvas></div>
            </div>
            <div class="bg-white rounded-xl shadow overflow-hidden"><div class="table-container"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">İlçe</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mahalle</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Görevli Personel</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Megsis Onay</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Netigma Onay</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Müdür Onay</th></tr></thead><tbody id="task-table" class="bg-white divide-y divide-gray-200"><tr><td colspan="6" class="text-center p-8 text-gray-500"><div id="loading-state-takip">Veriler yükleniyor...</div></td></tr></tbody></table></div></div>
        </div>
    </div>
    
    <!-- Modal (İş Takip için) -->
    <div id="entry-modal" class="fixed z-10 inset-0 overflow-y-auto hidden"><div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0"><div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div><span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span><div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full"><div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4"><div class="sm:flex sm:items-start"><div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full"><h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">İş Girişi</h3><div class="mt-4 space-y-4"><div><label for="modal-ilce" class="block text-sm font-medium text-gray-700">İlçe</label><select id="modal-ilce" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></select></div><div><label for="modal-mahalle" class="block text-sm font-medium text-gray-700">Mahalle</label><select id="modal-mahalle" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></select></div><div><label for="modal-personel" class="block text-sm font-medium text-gray-700">Personel</label><input type="text" id="modal-personel" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-gray-100 rounded-md shadow-sm sm:text-sm" readonly></div><div><label for="megsis-date" class="block text-sm font-medium text-gray-700">MEGSİS Onay Tarihi</label><input type="date" id="megsis-date" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></div><div><label for="netigma-date" class="block text-sm font-medium text-gray-700">NETİGMA Onay Tarihi</label><input type="date" id="netigma-date" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></div><div><label for="mudur-date" class="block text-sm font-medium text-gray-700">MÜDÜR Onay Tarihi</label><input type="date" id="mudur-date" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></div></div></div></div></div><div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse"><button type="button" id="save-entry-btn" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">Kaydet</button><button type="button" id="cancel-btn" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:w-auto sm:text-sm">İptal</button></div></div></div></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- COMMON ELEMENTS ---
        const loginScreen = document.getElementById('login-screen');
        const mainApp = document.getElementById('main-app');
        const loginForm = document.getElementById('login-form');
        const errorMessage = document.getElementById('error-message');
        const analizTabBtn = document.getElementById('analiz-tab-btn');
        const takipTabBtn = document.getElementById('takip-tab-btn');
        const analizPage = document.getElementById('analiz-page');
        const takipPage = document.getElementById('takip-page');

        const GITHUB_TOKEN_PARTS = ['ghp_MAuvwYT', 'JDUiqFY5h72', 'CZeXnMKuxr', 'CJ08sfAl'];
        let isAnalizLoaded = false;
        let isTakipLoaded = false;

        // --- LOGIN LOGIC ---
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            if (username === 'mersinkm' && password === '503344') {
                loginScreen.classList.add('hidden');
                mainApp.classList.remove('hidden');
                initThaAnalizi(); // Load default page
            } else {
                errorMessage.classList.remove('hidden');
            }
        });

        // --- TAB SWITCHING LOGIC ---
        analizTabBtn.addEventListener('click', () => {
            takipPage.classList.add('hidden');
            analizPage.classList.remove('hidden');
            analizTabBtn.classList.add('active');
            takipTabBtn.classList.remove('active');
            if (!isAnalizLoaded) initThaAnalizi();
        });

        takipTabBtn.addEventListener('click', () => {
            analizPage.classList.add('hidden');
            takipPage.classList.remove('hidden');
            takipTabBtn.classList.add('active');
            analizTabBtn.classList.remove('active');
            if (!isTakipLoaded) initIsTakip();
        });

        // --- THA ANALİZİ SCRIPT (self-contained) ---
        const initThaAnalizi = (() => {
            let isLoaded = false;
            const nitelikBilgiMap = new Map([['Tarıma Elverişli Olmayan Yer',{kod:'TEOY',ekonomikDegeri:'VAR'}],['Kaya',{kod:'KAYA',ekonomikDegeri:'YOK'}],['Tepe',{kod:'TEPE',ekonomikDegeri:'VAR'}],['Dağ',{kod:'DAG',ekonomikDegeri:'YOK'}],['Orman',{kod:'ORM',ekonomikDegeri:'YOK'}],['Yol',{kod:'YOL',ekonomikDegeri:'YOK'}],['Dere',{kod:'DERE',ekonomikDegeri:'YOK'}],['Park',{kod:'PRK',ekonomikDegeri:'VAR'}],['Meydan',{kod:'MYD',ekonomikDegeri:'VAR'}],['Köprü',{kod:'KPR',ekonomikDegeri:'YOK'}],['Deniz',{kod:'DNZ',ekonomikDegeri:'YOK'}],['Göl',{kod:'GOL',ekonomikDegeri:'YOK'}],['Nehir',{kod:'NHR',ekonomikDegeri:'YOK'}],['Çalılık',{kod:'CALI',ekonomikDegeri:'VAR'}],['Fundaluk',{kod:'FND',ekonomikDegeri:'VAR'}],['Sarı Alan Arazisi',{kod:'SAA',ekonomikDegeri:'VAR'}],['Yunak',{kod:'YNK',ekonomikDegeri:'VAR'}],['Mezarlık',{kod:'MZR',ekonomikDegeri:'YOK'}],['Kuyu',{kod:'KY',ekonomikDegeri:'YOK'}],['Çeşme',{kod:'CSM',ekonomikDegeri:'YOK'}],['Namazgah',{kod:'NMZ',ekonomikDegeri:'YOK'}],['Cami',{kod:'CAMI',ekonomikDegeri:'YOK'}],['Köy Odası',{kod:'KO',ekonomikDegeri:'YOK'}],['Pazar Yeri',{kod:'PY',ekonomikDegeri:'VAR'}],['Ark',{kod:'ARK',ekonomikDegeri:'YOK'}],['Kanal',{kod:'KNL',ekonomikDegeri:'YOK'}],['Aklan',{kod:'AKLN',ekonomikDegeri:'YOK'}],['Taşlık',{kod:'TSLK',ekonomikDegeri:'VAR'}],['Çay',{kod:'CAY',ekonomikDegeri:'YOK'}],['Su Deposu',{kod:'SD',ekonomikDegeri:'YOK'}],['Köy Boşluğu',{kod:'KB',ekonomikDegeri:'VAR'}],['Tampon Bölge',{kod:'TB',ekonomikDegeri:'VAR'}],['Kadastrosu Yapılmamış Alan',{kod:'KYA',ekonomikDegeri:'VAR'}],['Yol Fazlası',{kod:'YF',ekonomikDegeri:'VAR'}],['Kumluk',{kod:'KMLK',ekonomikDegeri:'VAR'}],['Ham Toprak',{kod:'HT',ekonomikDegeri:'VAR'}],['Hali Arazi',{kod:'HA',ekonomikDegeri:'VAR'}],['Yamaç',{kod:'YMC',ekonomikDegeri:'YOK'}],['Kenarlaşma Sorunu',{kod:'KS',ekonomikDegeri:'VAR'}],['Davalı/Tescilsiz Parsel',{kod:'DTA',ekonomikDegeri:'VAR'}],['Belediye Hizmet Alanı',{kod:'BHA',ekonomikDegeri:'VAR'}],['Yol Boşluğu',{kod:'YB',ekonomikDegeri:'VAR'}],['Pınar',{kod:'PNR',ekonomikDegeri:'YOK'}],['Koru',{kod:'KORU',ekonomikDegeri:'VAR'}],['Baraj',{kod:'BRJ',ekonomikDegeri:'YOK'}],['Hendek',{kod:'HNDK',ekonomikDegeri:'VAR'}],['Kıraç Arazi',{kod:'KA',ekonomikDegeri:'VAR'}],['Çatak',{kod:'ÇTK',ekonomikDegeri:'VAR'}],['Bayır',{kod:'BYR',ekonomikDegeri:'VAR'}],['Yeşil Alan',{kod:'YA',ekonomikDegeri:'VAR'}],['Otopark',{kod:'OTP',ekonomikDegeri:'VAR'}],['Harman Yeri',{kod:'HY',ekonomikDegeri:'VAR'}],['Trafo Yeri',{kod:'TY',ekonomikDegeri:'YOK'}],['Sulama Hattı',{kod:'SH',ekonomikDegeri:'YOK'}],['Kıyı',{kod:'KIYI',ekonomikDegeri:'VAR'}],['Sağlık Koruma Bandı',{kod:'SKB',ekonomikDegeri:'VAR'}],['Obuz',{kod:'OBZ',ekonomikDegeri:'VAR'}],['Değirmen Bendi',{kod:'DB',ekonomikDegeri:'VAR'}],['2B Alanı',{kod:'IKIB',ekonomikDegeri:'VAR'}],['Kesik',{kod:'KSK',ekonomikDegeri:'VAR'}],['Sazlık/Bataklık',{kod:'SZBT',ekonomikDegeri:'VAR'}],['Irmak',{kod:'IRMK',ekonomikDegeri:'YOK'}],['Devlet Hükmü ve Tasarrufu Altındaki Yerler',{kod:'DHTA',ekonomikDegeri:'VAR'}],['Ağaçlık',{kod:'AGC',ekonomikDegeri:'VAR'}],['Tonç',{kod:'TONC',ekonomikDegeri:'VAR'}],['Pilon Yeri',{kod:'PY',ekonomikDegeri:'YOK'}],['Yar',{kod:'YAR',ekonomikDegeri:'YOK'}],['Mera',{kod:'MERA',ekonomikDegeri:'VAR'}],['Rezerv Alan',{kod:'RA',ekonomikDegeri:'VAR'}],['Geometrisi Tespit Edilemeyen Parsel',{kod:'GTEP',ekonomikDegeri:'VAR'}],['Pırnallık',{kod:'PRNL',ekonomikDegeri:'VAR'}],['Su Kaynağı',{kod:'SK',ekonomikDegeri:'VAR'}],['Ağaçlandırılacak Alan',{kod:'AA',ekonomikDegeri:'VAR'}],['Su Yolu',{kod:'SY',ekonomikDegeri:'YOK'}],['Akıntı',{kod:'AKNT',ekonomikDegeri:'YOK'}],['Demiryolu',{kod:'DY',ekonomikDegeri:'YOK'}],['Tump',{kod:'TUMP',ekonomikDegeri:'VAR'}],['Dekovil',{kod:'DKVL',ekonomikDegeri:'YOK'}],['Çocuk Bahçesi',{kod:'ÇB',ekonomikDegeri:'VAR'}],['Otoyol',{kod:'OTOYOL',ekonomikDegeri:'YOK'}],['Spor Tesisi Alanı',{kod:'STA',ekonomikDegeri:'VAR'}],['Şev',{kod:'ŞEV',ekonomikDegeri:'YOK'}],['Teknik Altyapı Alanı',{kod:'TAA',ekonomikDegeri:'VAR'}]]);
            let nitelikSiralamaAnaliz = [];
            const tableBody = document.getElementById('data-table');
            const searchInput = document.getElementById('search-input');
            const ilceSelect = document.getElementById('ilce-select');
            const ekonomikVarIlceToplamEl = document.getElementById('ekonomik-var-ilce-toplam');
            const ekonomikYokIlceToplamEl = document.getElementById('ekonomik-yok-ilce-toplam');
            const genelToplamEl = document.getElementById('genel-toplam');
            const toplamKartBaslikEl = document.getElementById('toplam-kart-baslik');
            const loadingState = document.getElementById('loading-state-analiz');
            const downloadButton = document.getElementById('download-excel');
            const toggleChartButton = document.getElementById('toggle-chart');
            const chartContainer = document.getElementById('chart-container');
            let allData = [], currentIlce = 'Genel Toplam', currentSort = { key: null, direction: 'asc' };
            let nitelikBarChartInstance, ilceBarChartInstance;

            async function fetchThaData() { 
                const token = GITHUB_TOKEN_PARTS.join('');
                const owner = 'gokhangeo';
                const repo = 'mersin-th';
                const path = 'THA.xlsx';
                const apiUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
                const response = await fetch(apiUrl, { headers: { 'Authorization': `token ${token}` } });
                if (!response.ok) throw new Error(`GitHub API'den veri çekilemedi: ${response.statusText}`);
                const data = await response.json();
                const decodedContent = atob(data.content);
                const workbook = XLSX.read(decodedContent, { type: 'binary' });
                const thData = XLSX.utils.sheet_to_json(workbook.Sheets['TH'], { header: 1, raw: true });
                const adetData = XLSX.utils.sheet_to_json(workbook.Sheets['Adet'], { header: 1, raw: true });
                return { thData, adetData };
            }
            
            function processThaData({ thData, adetData }) {
                const allIlceData = [];
                const thHeaders = thData[0];
                const thNitelikler = thData.slice(1);
                nitelikSiralamaAnaliz = thNitelikler
                    .map(row => String(row[0] || '').trim())
                    .filter(nitelikName => nitelikName && nitelikName.toLowerCase() !== 'genel toplam');
                
                const adetHeaders = adetData[0];
                const adetNitelikler = adetData.slice(1).reduce((map, row) => {
                    map[String(row[0] || '').trim()] = row;
                    return map;
                }, {});
                const ilceNames = thHeaders.slice(1);
                thNitelikler.forEach(row => {
                    const nitelikName = String(row[0] || '').trim();
                    if (!nitelikName || nitelikName.toLowerCase() === 'genel toplam') return;
                    const adetRow = adetNitelikler[nitelikName];
                    ilceNames.forEach((ilceName, index) => {
                        const cleanIlceName = String(ilceName || '').trim();
                        if (cleanIlceName.toLowerCase() === 'genel toplam') return; 
                        
                        const yuzolcumHa = parseFloat(row[index + 1]) || 0;
                        const adet = adetRow ? (parseInt(adetRow[index + 1]) || 0) : 0;
                        const bilgi = nitelikBilgiMap.get(nitelikName) || { kod: 'BİLİNMİYOR', ekonomikDegeri: 'VAR' };
                        
                        allIlceData.push({
                            nitelik: nitelikName,
                            ilce: cleanIlceName,
                            kod: bilgi.kod,
                            adet: adet,
                            ekonomikDegeri: bilgi.ekonomikDegeri,
                            yuzolcumM2: yuzolcumHa * 10000,
                            yuzolcumHa: yuzolcumHa
                        });
                    });
                });
                const genelToplamMap = new Map();
                allIlceData.forEach(item => {
                    const current = genelToplamMap.get(item.nitelik) || { yuzolcumM2: 0, adet: 0 };
                    genelToplamMap.set(item.nitelik, {
                        yuzolcumM2: current.yuzolcumM2 + item.yuzolcumM2,
                        adet: current.adet + item.adet
                    });
                });
                genelToplamMap.forEach((totals, nitelikName) => {
                     const bilgi = nitelikBilgiMap.get(nitelikName) || { kod: 'BİLİNMİYOR', ekonomikDegeri: 'VAR' };
                     allIlceData.push({
                         nitelik: nitelikName,
                         ilce: 'Genel Toplam',
                         kod: bilgi.kod,
                         adet: totals.adet,
                         ekonomikDegeri: bilgi.ekonomikDegeri,
                         yuzolcumM2: totals.yuzolcumM2,
                         yuzolcumHa: totals.yuzolcumM2 / 10000
                     });
                });
                return allIlceData;
            }

            function formatNumber(num) { return new Intl.NumberFormat('tr-TR').format(num); }
            
            function renderThaTable(data) {
                tableBody.innerHTML = '';
                if (data.length === 0) { tableBody.innerHTML = `<tr><td colspan="6" class="text-center py-12 px-6 text-gray-500">Arama sonucu boş.</td></tr>`; return; }
                data.forEach(item => {
                    const ekonomikDegerClass = item.ekonomikDegeri === 'VAR' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                    const row = `
                        <tr class="hover:bg-gray-50"><td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.nitelik}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.kod}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right">${formatNumber(item.adet)}</td><td class="px-6 py-4 whitespace-nowrap text-sm"><span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${ekonomikDegerClass}">${item.ekonomikDegeri}</span></td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right">${formatNumber(item.yuzolcumM2)}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right">${formatNumber(item.yuzolcumHa)}</td></tr>`;
                    tableBody.innerHTML += row;
                });
            }

             function renderThaCharts(data) {
                renderNitelikBarChart(data);
                renderIlceBarChart();
            }

            function renderNitelikBarChart(data){
                const ctx = document.getElementById('nitelikBarChart').getContext('2d');
                if (nitelikBarChartInstance) nitelikBarChartInstance.destroy();
                const chartData = [...data].filter(d => d.yuzolcumM2 > 0).sort((a,b) => b.yuzolcumM2 - a.yuzolcumM2).slice(0, 15);
                nitelikBarChartInstance = new Chart(ctx, { type: 'bar', data: { labels: chartData.map(d => d.nitelik), datasets: [{ label: 'Yüzölçüm (m²)', data: chartData.map(d => d.yuzolcumM2), backgroundColor: '#4C78A8' }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true } } } });
            }

            function renderIlceBarChart(){
                const ctx = document.getElementById('ilceBarChart').getContext('2d');
                if (ilceBarChartInstance) ilceBarChartInstance.destroy();
                const searchTerm = searchInput.value.trim();
                if (!searchTerm) {
                    ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                    ctx.font = "16px Inter";
                    ctx.fillStyle = "#6b7280";
                    ctx.textAlign = "center";
                    ctx.fillText("İlçe karşılaştırması için bir nitelik arayın.", ctx.canvas.width / 2, ctx.canvas.height / 2);
                    return;
                }
                const filteredByNitelik = allData.filter(d => d.nitelik.toLowerCase().includes(searchTerm.toLowerCase()) && d.ilce !== 'Genel Toplam' && d.yuzolcumM2 > 0);
                const chartData = filteredByNitelik.sort((a,b) => b.yuzolcumM2 - a.yuzolcumM2);
                const backgroundColors = ['#4C78A8', '#F58518', '#E45756', '#72B7B2', '#54A24B', '#EECA3B', '#B279A2', '#FF9DA6', '#9D755D', '#BAB0AC', '#66c2a5', '#fc8d62', '#8da0cb' ];
                ilceBarChartInstance = new Chart(ctx, { type: 'bar', data: { labels: chartData.map(d => d.ilce), datasets: [{ label: `${searchTerm} Alan Dağılımı (m²)`, data: chartData.map(d => d.yuzolcumM2), backgroundColor: chartData.map((_, i) => backgroundColors[i % backgroundColors.length]) }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true } } } });
            }

            function updateThaView() {
                const searchTerm = searchInput.value.toLowerCase().trim();
                const districtRawData = allData.filter(item => item.ilce === currentIlce);
                let completeDistrictData = nitelikSiralamaAnaliz.map(nitelikName => {
                    const existingItem = districtRawData.find(item => item.nitelik === nitelikName);
                    if (existingItem) return existingItem;
                    const bilgi = nitelikBilgiMap.get(nitelikName) || { kod: 'BİLİNMİYOR', ekonomikDegeri: 'VAR' };
                    return { nitelik: nitelikName, ilce: currentIlce, kod: bilgi.kod, adet: 0, ekonomikDegeri: bilgi.ekonomikDegeri, yuzolcumM2: 0, yuzolcumHa: 0 };
                });
                const totals = completeDistrictData.reduce((acc, item) => { item.ekonomikDegeri === 'VAR' ? acc.var += item.yuzolcumM2 : acc.yok += item.yuzolcumM2; return acc; }, { var: 0, yok: 0 });
                ekonomikVarIlceToplamEl.textContent = `${formatNumber(totals.var)} m²`;
                ekonomikYokIlceToplamEl.textContent = `${formatNumber(totals.yok)} m²`;
                const totalForDynamicCard = completeDistrictData.reduce((acc, item) => acc + item.yuzolcumM2, 0);
                toplamKartBaslikEl.textContent = currentIlce === 'Genel Toplam' ? 'Mersin Genel Toplam' : `${currentIlce} Genel Toplam`;
                genelToplamEl.textContent = `${formatNumber(totalForDynamicCard)} m²`;
                let filteredData = completeDistrictData;
                if (searchTerm) { filteredData = filteredData.filter(item => item.nitelik.toLowerCase().includes(searchTerm)); }
                if (currentSort.key) {
                    filteredData.sort((a, b) => {
                        const valA = a[currentSort.key], valB = b[currentSort.key];
                        const direction = currentSort.direction === 'asc' ? 1 : -1;
                        return typeof valA === 'string' ? valA.localeCompare(valB) * direction : (valA - valB) * direction;
                    });
                }
                renderThaTable(filteredData);
                if (!chartContainer.classList.contains('hidden')) { renderThaCharts(completeDistrictData); }
            }
            
            function downloadExcel() { /* ... unchanged ... */ }
            
            async function init() {
                if(isLoaded) return;
                isLoaded = true;
                isAnalizLoaded = true;
                loadingState.textContent = 'GitHub\'dan veriler yükleniyor...';
                try {
                    const rawData = await fetchThaData();
                    allData = processThaData(rawData);
                    const ilceler = ['Genel Toplam', ...[...new Set(allData.map(item => item.ilce))].filter(i => i !== 'Genel Toplam').sort((a,b) => a.localeCompare(b, 'tr'))];
                    ilceSelect.innerHTML = ilceler.map(i => `<option value="${i}">${i}</option>`).join('');
                    ilceSelect.value = 'Genel Toplam';
                    updateThaView();
                    searchInput.disabled = false;
                    ilceSelect.disabled = false;
                    downloadButton.disabled = false;
                    toggleChartButton.disabled = false;
                    loadingState.parentElement.parentElement.remove();
                } catch (error) {
                    console.error("THA Analiz veri yükleme hatası:", error);
                    loadingState.textContent = "Veriler yüklenemedi.";
                    loadingState.classList.add('text-red-500');
                }
            }
             // Event Listeners for THA Analizi
            ilceSelect.addEventListener('change', (e) => { currentIlce = e.target.value; searchInput.value = ''; currentSort = { key: null, direction: 'asc' }; document.querySelectorAll('#analiz-page th .sort-icon').forEach(icon => icon.classList.remove('active')); updateThaView(); });
            searchInput.addEventListener('input', updateThaView);
            downloadButton.addEventListener('click', downloadExcel);
            toggleChartButton.addEventListener('click', () => { chartContainer.classList.toggle('hidden'); if(!chartContainer.classList.contains('hidden')) updateThaView(); });
            document.querySelectorAll('#analiz-page th[data-sort-by]').forEach(th => {
                th.addEventListener('click', () => {
                    const sortKey = th.dataset.sortBy;
                    let direction = (currentSort.key === sortKey && currentSort.direction === 'asc') ? 'desc' : 'asc';
                    if (currentSort.key !== sortKey && (sortKey === 'yuzolcumM2' || sortKey === 'yuzolcumHa' || sortKey === 'adet')) direction = 'desc';
                    currentSort = { key: sortKey, direction };
                    document.querySelectorAll('#analiz-page th .sort-icon').forEach(icon => icon.classList.remove('active'));
                    th.querySelector('.sort-icon').classList.add('active');
                    updateThaView();
                });
            });
            return init;
        })();
        // --- İŞ TAKİP SCRIPT (self-contained) ---
        const initIsTakip = (() => {
            let isLoaded = false;
            const ilceFilter = document.getElementById('takip-ilce-filter');
            const mahalleFilter = document.getElementById('takip-mahalle-filter');
            const personelFilter = document.getElementById('takip-personel-filter');
            const taskTable = document.getElementById('task-table');
            const addEntryBtn = document.getElementById('add-entry-btn');
            const modal = document.getElementById('entry-modal');
            const cancelBtn = document.getElementById('cancel-btn');
            const saveEntryBtn = document.getElementById('save-entry-btn');
            const modalTitle = document.getElementById('modal-title');
            const modalIlce = document.getElementById('modal-ilce');
            const modalMahalle = document.getElementById('modal-mahalle');
            const modalPersonel = document.getElementById('modal-personel');
            const megsisDate = document.getElementById('megsis-date');
            const netigmaDate = document.getElementById('netigma-date');
            const mudurDate = document.getElementById('mudur-date');
            const loadingState = document.getElementById('loading-state-takip');
            const downloadChartBtn = document.getElementById('download-chart-btn');
            const downloadTakipExcelBtn = document.getElementById('download-takip-excel-btn');
            let personelData = [], taskData = [], personelFileSha = '';
            let personelChartInstance;
            const GITHUB_FILE_URL = 'https://api.github.com/repos/gokhangeo/mersin-th/contents/Personel.xlsx';
            
            Chart.register(ChartDataLabels);

            async function loadTakipData() {
                 try {
                    loadingState.textContent = 'GitHub\'dan veriler okunuyor...';
                    const token = GITHUB_TOKEN_PARTS.join('');
                    const response = await fetch(GITHUB_FILE_URL, { headers: { 'Authorization': `token ${token}` } });
                    if (!response.ok) throw new Error('GitHub\'dan Personel verisi alınamadı.');
                    const fileData = await response.json();
                    personelFileSha = fileData.sha;
                    const fileContent = atob(fileData.content);
                    const workbook = XLSX.read(fileContent, { type: 'binary' });
                    personelData = [];
                    taskData = [];
                    workbook.SheetNames.forEach(sheetName => {
                        const json = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
                        json.forEach(row => {
                            const mahalle = row['Mahalle Adı'];
                            const personel = row['GÖREVLİ PERSONEL'];
                            if (mahalle && personel) {
                                 const megsis = row['MEGSİS ONAY TARİHİ'] ? excelDateToJSDate(row['MEGSİS ONAY TARİHİ']) : '';
                                 const netigma = row['NETİGMA ONAY TARİHİ'] ? excelDateToJSDate(row['NETİGMA ONAY TARİHİ']) : '';
                                 const mudur = row['MÜDÜR ONAY'] ? excelDateToJSDate(row['MÜDÜR ONAY']) : '';
                                 taskData.push({ ilce: sheetName, mahalle, personel, megsis, netigma, mudur });
                            }
                        });
                    });
                    populateTakipFilters();
                    renderTakipTable();
                    if(loadingState && loadingState.parentElement) loadingState.parentElement.parentElement.remove();
                } catch (error) {
                    console.error('İş Takip veri yüklenirken hata:', error);
                    if(loadingState) {
                        loadingState.textContent = "Veriler yüklenemedi.";
                        loadingState.classList.add('text-red-500');
                    }
                }
            }
            function excelDateToJSDate(excelDate) {
                if(typeof excelDate === 'string' && excelDate.includes('-')) return excelDate;
                if(typeof excelDate !== 'number') return '';
                const date = new Date((excelDate - 25569) * 86400 * 1000);
                return date.toISOString().split('T')[0];
            }
            async function saveDataToGitHub() {
                saveEntryBtn.disabled = true;
                saveEntryBtn.textContent = 'Kaydediliyor...';
                try {
                    const wb = XLSX.utils.book_new();
                    const ilceler = [...new Set(taskData.map(p => p.ilce))].sort();
                    
                    ilceler.forEach(ilce => {
                        const sheetData = taskData
                            .filter(p => p.ilce === ilce)
                            .map(p => ({
                                'Mahalle Adı': p.mahalle,
                                'GÖREVLİ PERSONEL': p.personel,
                                'MEGSİS ONAY TARİHİ': p.megsis || undefined,
                                'NETİGMA ONAY TARİHİ': p.netigma || undefined,
                                'MÜDÜR ONAY': p.mudur || undefined
                            }));
                        const ws = XLSX.utils.json_to_sheet(sheetData);
                        XLSX.utils.book_append_sheet(wb, ws, ilce);
                    });
                    const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'base64' });
                    const token = GITHUB_TOKEN_PARTS.join('');
                    const response = await fetch(GITHUB_FILE_URL, {
                        method: 'PUT',
                        headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: `[THA Sistemi] Veri Güncelleme`, content: wbout, sha: personelFileSha })
                    });
                    if (!response.ok) throw new Error(await response.text());
                    alert('Veri başarıyla GitHub\'a kaydedildi!');
                    await loadTakipData();
                } catch (error) {
                    console.error('Kaydetme hatası:', error);
                    alert(`Bir hata oluştu: ${error.message}`);
                } finally {
                    saveEntryBtn.disabled = false;
                    saveEntryBtn.textContent = 'Kaydet';
                    modal.classList.add('hidden');
                }
            }
            function populateTakipFilters() { 
                const ilceler = ['Tümü', ...new Set(taskData.map(p => p.ilce).sort())];
                const mahalleler = ['Tümü', ...new Set(taskData.map(p => p.mahalle).sort())];
                const personeller = ['Tümü', ...new Set(taskData.map(p => p.personel).sort())];

                ilceFilter.innerHTML = ilceler.map(i => `<option value="${i}">${i}</option>`).join('');
                mahalleFilter.innerHTML = mahalleler.map(m => `<option value="${m}">${m}</option>`).join('');
                personelFilter.innerHTML = personeller.map(p => `<option value="${p}">${p}</option>`).join('');
             }
            function renderTakipTable() { 
                const selectedIlce = ilceFilter.value;
                const selectedMahalle = mahalleFilter.value;
                const selectedPersonel = personelFilter.value;

                let displayData = taskData.filter(task => 
                    (selectedIlce === 'Tümü' || task.ilce === selectedIlce) &&
                    (selectedMahalle === 'Tümü' || task.mahalle === selectedMahalle) &&
                    (selectedPersonel === 'Tümü' || task.personel === selectedPersonel)
                );

                if (selectedPersonel !== 'Tümü') {
                    displayData.sort((a,b) => (b.megsis || b.netigma) ? 1 : (a.megsis || a.netigma) ? -1 : 0);
                }

                if(displayData.length === 0){
                    taskTable.innerHTML = `<tr><td colspan="6" class="text-center p-8 text-gray-500">Filtreye uygun kayıt bulunamadı.</td></tr>`;
                } else {
                     taskTable.innerHTML = displayData.map((task) => `
                        <tr class="hover:bg-gray-50" data-task-ilce="${task.ilce}" data-task-mahalle="${task.mahalle}">
                            <td class="px-6 py-4 whitespace-nowrap">${task.ilce}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${task.mahalle}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${task.personel}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${task.megsis || '-'}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${task.netigma || '-'}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${task.mudur || '-'}</td>
                        </tr>`).join('');
                }
                 document.querySelectorAll('#task-table tr').forEach(row => {
                    row.addEventListener('click', () => openEditModal(row.dataset.taskIlce, row.dataset.taskMahalle));
                });
                renderTakipChart(displayData);
            }
            function renderTakipChart(data) { 
                const ctx = document.getElementById('personelChart').getContext('2d');
                if (personelChartInstance) personelChartInstance.destroy();
                const personelCounts = data.reduce((acc, task) => { if(task.megsis || task.netigma) {acc[task.personel] = (acc[task.personel] || 0) + 1;} return acc; }, {});
                const sortedPersonel = Object.entries(personelCounts).sort(([,a],[,b]) => b-a);
                personelChartInstance = new Chart(ctx, { 
                    type: 'bar', 
                    data: { 
                        labels: sortedPersonel.map(e => e[0]), 
                        datasets: [{ 
                            label: 'Toplam Giriş Sayısı', 
                            data: sortedPersonel.map(e => e[1]), 
                            backgroundColor: '#3b82f6' 
                        }] 
                    }, 
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        plugins: {
                            legend: { display: false },
                            datalabels: {
                                anchor: 'end',
                                align: 'end',
                                color: '#444',
                                font: {
                                    weight: 'bold'
                                }
                            }
                        },
                        scales: { 
                            y: { 
                                beginAtZero: true, 
                                ticks: { stepSize: 1 } 
                            } 
                        } 
                    },
                    plugins: [ChartDataLabels]
                });
            }
            function openEditModal(ilce, mahalle) { /* ... unchanged ... */ }
            async function init() {
                if(isLoaded) return;
                isLoaded = true;
                isTakipLoaded = true;
                await loadTakipData();
                
                ilceFilter.addEventListener('change', () => {
                     const selectedIlce = ilceFilter.value;
                     const mahalleler = ['Tümü', ...new Set(taskData.filter(p => selectedIlce === 'Tümü' || p.ilce === selectedIlce).map(p => p.mahalle).sort())];
                     mahalleFilter.innerHTML = mahalleler.map(m => `<option value="${m}">${m}</option>`).join('');
                     renderTakipTable();
                });
                mahalleFilter.addEventListener('change', renderTakipTable);
                personelFilter.addEventListener('change', renderTakipTable);

                addEntryBtn.addEventListener('click', () => {
                    modalTitle.textContent = 'Yeni İş Girişi';
                    modalIlce.disabled = false;
                    modalMahalle.disabled = false;
                    const ilceler = [...new Set(taskData.map(p => p.ilce))].sort();
                    modalIlce.innerHTML = `<option value="">İlçe Seçin</option>` + ilceler.map(i => `<option value="${i}">${i}</option>`).join('');
                    modalMahalle.innerHTML = `<option value="">Önce İlçe Seçin</option>`;
                    modalPersonel.value = '';
                    megsisDate.value = '';
                    netigmaDate.value = '';
                    mudurDate.value = '';
                    modal.classList.remove('hidden');
                });
                modalIlce.addEventListener('change', () => {
                     const selectedIlce = modalIlce.value;
                     const mahalleler = [...new Set(taskData.filter(p => p.ilce === selectedIlce).map(p => p.mahalle).sort())];
                     modalMahalle.innerHTML = `<option value="">Mahalle Seçin</option>` + mahalleler.map(m => `<option value="${m}">${m}</option>`).join('');
                });
                modalMahalle.addEventListener('change', () => {
                    const gorevli = taskData.find(p => p.ilce === modalIlce.value && p.mahalle === modalMahalle.value);
                    modalPersonel.value = gorevli ? gorevli.personel : 'Atanmamış';
                });
                cancelBtn.addEventListener('click', () => modal.classList.add('hidden'));

                saveEntryBtn.addEventListener('click', () => {
                    const ilce = modalIlce.value;
                    const mahalle = modalMahalle.value;

                    if (!ilce || !mahalle) { alert('Lütfen ilçe ve mahalle seçin.'); return; }
                    
                    let task = taskData.find(t => t.ilce === ilce && t.mahalle === mahalle);
                    
                    if (task) { // Update existing
                        task.megsis = megsisDate.value;
                        task.netigma = netigmaDate.value;
                        task.mudur = mudurDate.value;
                    } else { // Create new
                         task = { ilce, mahalle, personel: modalPersonel.value, megsis: megsisDate.value, netigma: netigmaDate.value, mudur: mudurDate.value };
                        taskData.push(task);
                    }
                    saveDataToGitHub();
                });
                
                downloadChartBtn.addEventListener('click', () => {
                    const canvas = document.getElementById('personelChart');
                    const image = canvas.toDataURL('image/jpeg', 1.0);
                    const link = document.createElement('a');
                    link.href = image;
                    link.download = 'personel-giris-grafigi.jpg';
                    link.click();
                });
            }
            return init;
        })();
    });
    </script>
</body>
</html>

