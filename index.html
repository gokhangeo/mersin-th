<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mersin Ä°li THA Ä°ÅŸ Takip Sistemi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .table-container {
            max-height: 60vh;
            overflow-y: auto;
            overflow-x: auto;
        }
        .table-container::-webkit-scrollbar { width: 8px; height: 8px; }
        .table-container::-webkit-scrollbar-track { background: #f1f1f1; }
        .table-container::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        .table-container::-webkit-scrollbar-thumb:hover { background: #555; }
        #task-table tr, #notes-table-body tr, #approval-table-body tr, #bolge-iade-table-body tr {
            cursor: pointer;
        }
        .ilce-header .arrow {
            transition: transform 0.3s;
        }
        .ilce-header.open .arrow {
            transform: rotate(180deg);
        }
        @keyframes blink {
            50% { opacity: 0.5; }
        }
        .animate-blink {
            animation: blink 1.5s linear infinite;
        }
    </style>
</head>
<body class="text-gray-800">
    <input type="file" id="bolge-iade-file-input" class="hidden" accept=".xlsx, .xls, .csv">
    <!-- Login Screen -->
    <div id="login-screen" class="flex items-center justify-center min-h-screen bg-gradient-to-br from-blue-100 to-gray-100">
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-xl shadow-2xl">
            <h2 class="text-3xl font-bold text-center text-gray-700">THA SÄ°STEMÄ°</h2>
            <p class="text-center text-gray-500">Devam etmek iÃ§in lÃ¼tfen giriÅŸ yapÄ±n.</p>
            <form id="login-form" class="space-y-6">
                <div>
                    <input id="username" type="text" required class="w-full px-4 py-2 text-gray-700 bg-gray-100 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="KullanÄ±cÄ± AdÄ±">
                </div>
                <div>
                    <input id="password" type="password" required class="w-full px-4 py-2 text-gray-700 bg-gray-100 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Åžifre">
                </div>
                <div id="error-message" class="text-red-500 text-sm text-center hidden">HatalÄ± kullanÄ±cÄ± adÄ± veya ÅŸifre.</div>
                <div>
                    <button type="submit" class="w-full px-4 py-2 font-bold text-white bg-green-600 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50">
                        GiriÅŸ Yap
                    </button>
                </div>
            </form>
             <p class="text-center text-xs text-gray-400">Â© GÃ¶khan ELGÃœL tarafÄ±ndan tasarlanmÄ±ÅŸtÄ±r.</p>
        </div>
    </div>

    <!-- Main Application -->
    <div id="main-app" class="hidden">
        <!-- Ä°ÅŸ Takip Page -->
        <div id="takip-page" class="container mx-auto p-4 md:p-8">
             <header class="text-center mb-8">
                <h1 class="text-3xl md:text-4xl font-bold text-gray-800">MERSÄ°N Ä°LÄ° THA Ä°Åž TAKÄ°P SÄ°STEMÄ°</h1>
                <p class="text-gray-600 mt-2">Personel bazlÄ± MEGSÄ°S ve NETÄ°GMA giriÅŸ takibi.</p>
                <p class="text-xs text-gray-400 mt-2">Â© GÃ¶khan ELGÃœL tarafÄ±ndan tasarlanmÄ±ÅŸtÄ±r.</p>
            </header>
            
            <!-- Summary Cards -->
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6 mb-6">
                 <div id="bolge-iade-card" class="bg-white p-4 rounded-xl shadow text-center cursor-pointer hover:bg-gray-50 transition">
                    <h3 class="text-sm font-medium text-gray-500">BÃ¶lge Ä°ade KontrolÃ¼</h3>
                    <p class="mt-1 text-3xl font-semibold text-cyan-500">ðŸ”„</p>
                </div>
                <div id="performans-raporu-card" class="bg-white p-4 rounded-xl shadow text-center cursor-pointer hover:bg-gray-50 transition">
                    <h3 class="text-sm font-medium text-gray-500">Performans Raporu</h3>
                    <p class="mt-1 text-3xl font-semibold text-orange-500">ðŸ“Š</p>
                </div>
                <div id="gunun-ozeti-card" class="bg-white p-4 rounded-xl shadow text-center cursor-pointer hover:bg-gray-50 transition">
                    <h3 class="text-sm font-medium text-gray-500">GÃ¼nÃ¼n Ã–zeti</h3>
                    <p id="gunun-ozeti-count" class="mt-1 text-3xl font-semibold text-teal-600">0</p>
                </div>
                <div class="bg-white p-4 rounded-xl shadow text-center">
                    <h3 class="text-sm font-medium text-gray-500">Toplam Mahalle</h3>
                    <p id="toplam-mahalle-count" class="mt-1 text-3xl font-semibold text-gray-900">0</p>
                </div>
                <div id="megsis-card" class="bg-white p-4 rounded-xl shadow text-center cursor-pointer hover:bg-gray-50 transition">
                    <h3 class="text-sm font-medium text-gray-500">Megsis Onay</h3>
                    <p id="megsis-onay-count" class="mt-1 text-3xl font-semibold text-green-600">0</p>
                </div>
                <div id="netigma-bekleyen-card" class="bg-white p-4 rounded-xl shadow text-center cursor-pointer hover:bg-gray-50 transition">
                    <h3 class="text-sm font-medium text-gray-500">Netigma Bekleyen</h3>
                    <p id="netigma-bekleyen-count" class="mt-1 text-3xl font-semibold text-pink-600">0</p>
                </div>
                <div id="netigma-card" class="bg-white p-4 rounded-xl shadow text-center cursor-pointer hover:bg-gray-50 transition">
                    <h3 class="text-sm font-medium text-gray-500">Netigma Onay</h3>
                    <p id="netigma-onay-count" class="mt-1 text-3xl font-semibold text-blue-600">0</p>
                </div>
                <div id="mudur-card" class="bg-white p-4 rounded-xl shadow text-center cursor-pointer hover:bg-gray-50 transition">
                    <h3 class="text-sm font-medium text-gray-500">MÃ¼dÃ¼r Onay</h3>
                    <p id="mudur-onay-count" class="mt-1 text-3xl font-semibold text-purple-600">0</p>
                </div>
                 <div id="not-card" class="bg-white p-4 rounded-xl shadow text-center cursor-pointer hover:bg-gray-50 transition">
                    <h3 class="text-sm font-medium text-gray-500">Not DÃ¼ÅŸÃ¼lenler</h3>
                    <p id="not-count" class="mt-1 text-3xl font-semibold text-yellow-500">0</p>
                </div>
            </div>

            <!-- Warning Sections -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                 <div id="netigma-onay-bekleyenler-container" class="p-4 bg-green-50 border border-green-200 rounded-lg hidden">
                    <h3 class="font-bold text-green-800 mb-3 text-center text-lg">Netigma OnayÄ± Bekleyenler</h3>
                    <div id="netigma-onay-bekleyenler-listesi" class="flex flex-wrap justify-center gap-2">
                        <!-- Blinking green items will be injected here by JS -->
                    </div>
                </div>
                <div id="megsis-bekleyenler-container" class="p-4 bg-red-50 border border-red-200 rounded-lg hidden">
                    <h3 class="font-bold text-red-800 mb-3 text-center text-lg">MEGSÄ°S OnayÄ± Bekleyen Notlar (Ä°ade Olanlar)</h3>
                    <div id="megsis-bekleyenler-listesi" class="flex flex-wrap justify-center gap-2">
                        <!-- Blinking items will be injected here by JS -->
                    </div>
                </div>
                <div id="geri-bildirim-bekleyenler-container" class="p-4 bg-blue-50 border border-blue-200 rounded-lg hidden">
                    <h3 class="font-bold text-blue-800 mb-3 text-center text-lg">Geri Bildirim Bekleyenler (Ä°ade Olanlar)</h3>
                    <div id="geri-bildirim-bekleyenler-listesi" class="flex flex-wrap justify-center gap-2">
                        <!-- Blinking items will be injected here by JS -->
                    </div>
                </div>
            </div>


            <div class="mb-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-6 items-end">
                <div class="bg-white p-4 rounded-xl shadow"><label for="takip-ilce-filter" class="block text-sm font-medium text-gray-700">Ä°lÃ§eye GÃ¶re Filtrele</label><select id="takip-ilce-filter" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></select></div>
                <div class="bg-white p-4 rounded-xl shadow"><label for="takip-mahalle-filter" class="block text-sm font-medium text-gray-700">Mahalleye GÃ¶re Filtrele</label><select id="takip-mahalle-filter" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></select></div>
                <div class="bg-white p-4 rounded-xl shadow"><label for="takip-personel-filter" class="block text-sm font-medium text-gray-700">Personele GÃ¶re Filtrele</label><select id="takip-personel-filter" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></select></div>
                <div class="bg-white p-4 rounded-xl shadow"><label for="hizli-arama-input" class="block text-sm font-medium text-gray-700">HÄ±zlÄ± Ara</label><input type="text" id="hizli-arama-input" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Ä°lÃ§e, mahalle, personel..."></div>
                 <div class="bg-white p-4 rounded-xl shadow flex flex-col space-y-2">
                    <button id="add-entry-btn" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Yeni GiriÅŸ Ekle</button>
                    <button id="download-takip-excel-btn" class="w-full bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">Tabloyu Ä°ndir</button>
                </div>
            </div>

            <!-- Interactive Accordion List -->
            <div id="interactive-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 mb-6">
                <!-- Ä°lÃ§e cards will be injected here -->
            </div>

            <div class="bg-white rounded-xl shadow overflow-hidden"><div class="table-container"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-2 py-3 sm:px-6 sm:py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ä°lÃ§e</th><th class="px-2 py-3 sm:px-6 sm:py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mahalle</th><th class="px-2 py-3 sm:px-6 sm:py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">GÃ¶revli Personel</th><th class="px-2 py-3 sm:px-6 sm:py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Megsis Onay</th><th class="px-2 py-3 sm:px-6 sm:py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Netigma Onay</th><th class="px-2 py-3 sm:px-6 sm:py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">MÃ¼dÃ¼r Onay</th><th class="px-2 py-3 sm:px-6 sm:py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Not</th></tr></thead><tbody id="task-table" class="bg-white divide-y divide-gray-200"><tr><td colspan="7" class="text-center p-8 text-gray-500"><div id="loading-state-takip">Veriler yÃ¼kleniyor...</div></td></tr></tbody></table></div></div>
        </div>
    </div>
    
    <!-- Modal (Ä°ÅŸ Takip iÃ§in) -->
    <div id="entry-modal" class="fixed z-30 inset-0 overflow-y-auto hidden"><div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0"><div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div><span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span><div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full"><div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4"><div class="sm:flex sm:items-start"><div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full"><h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">Ä°ÅŸ GiriÅŸi</h3><div class="mt-4 space-y-4"><div><label for="modal-ilce" class="block text-sm font-medium text-gray-700">Ä°lÃ§e</label><select id="modal-ilce" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></select></div><div><label for="modal-mahalle" class="block text-sm font-medium text-gray-700">Mahalle</label><select id="modal-mahalle" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></select></div><div><label for="modal-personel" class="block text-sm font-medium text-gray-700">Personel</label><input type="text" id="modal-personel" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-gray-100 rounded-md shadow-sm sm:text-sm" readonly></div><div><label for="megsis-date" class="block text-sm font-medium text-gray-700">MEGSÄ°S Onay Tarihi</label><input type="date" id="megsis-date" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></div><div><label for="netigma-date" class="block text-sm font-medium text-gray-700">NETÄ°GMA Onay Tarihi</label><input type="date" id="netigma-date" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></div><div><label for="mudur-date" class="block text-sm font-medium text-gray-700">MÃœDÃœR Onay Tarihi</label><input type="date" id="mudur-date" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></div><div><label for="modal-not" class="block text-sm font-medium text-gray-700">Not</label><textarea id="modal-not" rows="3" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></textarea></div><div id="not-tarihi-container" class="hidden"> <label for="not-tarihi" class="block text-sm font-medium text-gray-700">Not Tarihi</label> <input type="date" id="not-tarihi" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></div><div class="space-y-2 mt-4 border-t pt-4"><div class="flex items-center"><input id="is-geri-bildirim-check" type="checkbox" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"><label for="is-geri-bildirim-check" class="ml-2 block text-sm text-gray-900">Geri Bildirim Notu</label></div><div id="geri-bildirim-tamamlandi-container" class="hidden flex items-center"><input id="geri-bildirim-tamamlandi-check" type="checkbox" class="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded"><label for="geri-bildirim-tamamlandi-check" class="ml-2 block text-sm text-gray-900">Geri Bildirim TamamlandÄ±</label></div></div></div></div></div></div><div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse"><button type="button" id="save-entry-btn" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">Kaydet</button><button type="button" id="cancel-btn" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:w-auto sm:text-sm">Ä°ptal</button></div></div></div></div>

    <!-- Notes Modal -->
    <div id="notes-modal" class="fixed z-40 inset-0 overflow-y-auto hidden">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-5xl sm:w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="flex justify-between items-center">
                         <h3 class="text-lg leading-6 font-medium text-gray-900">Not DÃ¼ÅŸÃ¼len Birimler</h3>
                         <button id="download-notes-excel-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 text-sm">Excel Olarak Ä°ndir</button>
                    </div>
                    <div class="mt-4 table-container" style="max-height: 70vh;">
                         <table class="min-w-full divide-y divide-gray-200">
                             <thead class="bg-gray-50 sticky top-0">
                                 <tr>
                                     <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Durum</th>
                                     <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ä°lÃ§e</th>
                                     <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mahalle</th>
                                     <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Personel</th>
                                     <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Not Tarihi</th>
                                     <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Not</th>
                                 </tr>
                            </thead>
                            <tbody id="notes-table-body" class="bg-white divide-y divide-gray-200">
                                <!-- Notes will be injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" id="close-notes-modal-btn" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:w-auto sm:text-sm">Kapat</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Approval List Modal -->
    <div id="approval-modal" class="fixed z-40 inset-0 overflow-y-auto hidden">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="flex justify-between items-center">
                         <h3 id="approval-modal-title" class="text-lg leading-6 font-medium text-gray-900">OnaylÄ± Birimler</h3>
                    </div>
                    <div class="mt-4 table-container" style="max-height: 70vh;">
                         <table class="min-w-full divide-y divide-gray-200">
                             <thead class="bg-gray-50 sticky top-0">
                                 <tr>
                                     <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ä°lÃ§e</th>
                                     <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mahalle</th>
                                     <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Personel</th>
                                     <th id="approval-date-header" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Onay Tarihi</th>
                                 </tr>
                            </thead>
                            <tbody id="approval-table-body" class="bg-white divide-y divide-gray-200">
                                <!-- Approved items will be injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" id="close-approval-modal-btn" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:w-auto sm:text-sm">Kapat</button>
                </div>
            </div>
        </div>
    </div>

    <!-- GÃ¼nÃ¼n Ã–zeti Modal -->
    <div id="gunun-ozeti-modal" class="fixed z-40 inset-0 overflow-y-auto hidden">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="flex justify-between items-center">
                         <h3 class="text-lg leading-6 font-medium text-gray-900">GÃ¼nÃ¼n Ã–zeti</h3>
                         <button id="download-gunun-ozeti-excel-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 text-sm">Excel Olarak Ä°ndir</button>
                    </div>
                    <div class="mt-4 table-container" style="max-height: 70vh;">
                         <table class="min-w-full divide-y divide-gray-200">
                             <thead class="bg-gray-50 sticky top-0">
                                 <tr>
                                     <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ä°lÃ§e</th>
                                     <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mahalle</th>
                                     <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Personel</th>
                                     <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">BugÃ¼n YapÄ±lan Ä°ÅŸlem</th>
                                 </tr>
                            </thead>
                            <tbody id="gunun-ozeti-table-body" class="bg-white divide-y divide-gray-200">
                                <!-- Daily summary will be injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" id="close-gunun-ozeti-modal-btn" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:w-auto sm:text-sm">Kapat</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Personel Performans Raporu Modal -->
    <div id="performans-raporu-modal" class="fixed z-40 inset-0 overflow-y-auto hidden">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-6xl sm:w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg leading-6 font-medium text-gray-900">Personel Performans Raporu</h3>
                        <div class="flex space-x-2">
                            <button data-period="week" class="period-btn bg-gray-200 text-gray-700 font-bold py-1 px-3 rounded-lg hover:bg-gray-300 text-sm">Bu Hafta</button>
                            <button data-period="month" class="period-btn bg-gray-200 text-gray-700 font-bold py-1 px-3 rounded-lg hover:bg-gray-300 text-sm">Bu Ay</button>
                            <button data-period="all" class="period-btn bg-blue-600 text-white font-bold py-1 px-3 rounded-lg text-sm">TÃ¼m Zamanlar</button>
                        </div>
                    </div>
                    <div class="mt-4 table-container" style="max-height: 70vh;">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50 sticky top-0">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Personel</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Toplam GÃ¶rev</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Megsis GiriÅŸi</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Netigma GiriÅŸi</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">MÃ¼dÃ¼r OnayÄ±</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tamamlanan</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ort. Ä°ÅŸ GÃ¼nÃ¼ BaÅŸÄ±na Birim</th>
                                </tr>
                            </thead>
                            <tbody id="performans-table-body" class="bg-white divide-y divide-gray-200">
                                <!-- Performance data will be injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" id="close-performans-raporu-modal-btn" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:w-auto sm:text-sm">Kapat</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- BÃ¶lge Ä°ade Raporu Modal -->
    <div id="bolge-iade-modal" class="fixed z-40 inset-0 overflow-y-auto hidden">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="flex justify-between items-center">
                         <h3 class="text-lg leading-6 font-medium text-gray-900">BÃ¶lgeden Ä°ade Edilen Ä°ÅŸlemler</h3>
                    </div>
                    <div class="mt-4 table-container" style="max-height: 70vh;">
                         <table class="min-w-full divide-y divide-gray-200">
                             <thead class="bg-gray-50 sticky top-0">
                                 <tr>
                                     <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ä°lÃ§e</th>
                                     <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mahalle</th>
                                     <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Personel</th>
                                     <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">MÃ¼dÃ¼r Onay Tarihi</th>
                                 </tr>
                            </thead>
                            <tbody id="bolge-iade-table-body" class="bg-white divide-y divide-gray-200">
                                <!-- Results here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" id="close-bolge-iade-modal-btn" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:w-auto sm:text-sm">Kapat</button>
                </div>
            </div>
        </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const loginScreen = document.getElementById('login-screen');
        const mainApp = document.getElementById('main-app');
        const loginForm = document.getElementById('login-form');
        const errorMessage = document.getElementById('error-message');

        const GITHUB_TOKEN_PARTS = ['ghp_2KS6iY7t', '1ka6bKyHwO', 'NJkXdwOUVh', 'rU3PqlSX'];
        
        function toTitleCase(str) {
            if (!str) return '';
            // Ã–nce tÃ¼m metni kÃ¼Ã§Ã¼k harfe Ã§evir (TÃ¼rkÃ§e karakter desteÄŸiyle)
            let lower = str.toLocaleLowerCase('tr-TR');
            // Kelime baÅŸlarÄ±nÄ± bÃ¼yÃ¼k harf yap (TÃ¼rkÃ§e karakter desteÄŸiyle)
            return lower.replace(/\b\w/g, char => char.toLocaleUpperCase('tr-TR'));
        }
        
        function calculateWorkDays(startDate, endDate) {
            let count = 0;
            const curDate = new Date(startDate.getTime());
            while (curDate <= endDate) {
                const dayOfWeek = curDate.getDay();
                if (dayOfWeek !== 0 && dayOfWeek !== 6) { // 0 = Sunday, 6 = Saturday
                    count++;
                }
                curDate.setDate(curDate.getDate() + 1);
            }
            return count;
        }


        // --- LOGIN LOGIC ---
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            if (username === 'mersinkm' && password === '503344') {
                loginScreen.classList.add('hidden');
                mainApp.classList.remove('hidden');
                initIsTakip(); // Load default page
            } else {
                errorMessage.classList.remove('hidden');
            }
        });

        // --- Ä°Åž TAKÄ°P SCRIPT (self-contained) ---
        const initIsTakip = (() => {
            let isLoaded = false;
            const ilceFilter = document.getElementById('takip-ilce-filter');
            const mahalleFilter = document.getElementById('takip-mahalle-filter');
            const personelFilter = document.getElementById('takip-personel-filter');
            const hizliAramaInput = document.getElementById('hizli-arama-input');
            const taskTable = document.getElementById('task-table');
            const addEntryBtn = document.getElementById('add-entry-btn');
            const modal = document.getElementById('entry-modal');
            const cancelBtn = document.getElementById('cancel-btn');
            const saveEntryBtn = document.getElementById('save-entry-btn');
            const modalTitle = document.getElementById('modal-title');
            const modalIlce = document.getElementById('modal-ilce');
            const modalMahalle = document.getElementById('modal-mahalle');
            const modalPersonel = document.getElementById('modal-personel');
            const megsisDate = document.getElementById('megsis-date');
            const netigmaDate = document.getElementById('netigma-date');
            const mudurDate = document.getElementById('mudur-date');
            const modalNot = document.getElementById('modal-not');
            const notTarihiContainer = document.getElementById('not-tarihi-container');
            const notTarihiInput = document.getElementById('not-tarihi');
            const loadingState = document.getElementById('loading-state-takip');
            const downloadTakipExcelBtn = document.getElementById('download-takip-excel-btn');
            const toplamMahalleCountEl = document.getElementById('toplam-mahalle-count');
            const megsisCard = document.getElementById('megsis-card');
            const netigmaCard = document.getElementById('netigma-card');
            const mudurCard = document.getElementById('mudur-card');
            const megsisOnayCountEl = document.getElementById('megsis-onay-count');
            const netigmaOnayCountEl = document.getElementById('netigma-onay-count');
            const mudurOnayCountEl = document.getElementById('mudur-onay-count');
            const notCard = document.getElementById('not-card');
            const notCountEl = document.getElementById('not-count');
            const gununOzetiCard = document.getElementById('gunun-ozeti-card');
            const gununOzetiCountEl = document.getElementById('gunun-ozeti-count');
            const gununOzetiModal = document.getElementById('gunun-ozeti-modal');
            const closeGununOzetiModalBtn = document.getElementById('close-gunun-ozeti-modal-btn');
            const gununOzetiTableBody = document.getElementById('gunun-ozeti-table-body');
            const downloadGununOzetiExcelBtn = document.getElementById('download-gunun-ozeti-excel-btn');
            const netigmaBekleyenCard = document.getElementById('netigma-bekleyen-card');
            const netigmaBekleyenCountEl = document.getElementById('netigma-bekleyen-count');
            const mefsisBekleyenlerContainer = document.getElementById('megsis-bekleyenler-container');
            const mefsisBekleyenlerListesi = document.getElementById('megsis-bekleyenler-listesi');
            const geriBildirimBekleyenlerContainer = document.getElementById('geri-bildirim-bekleyenler-container');
            const geriBildirimBekleyenlerListesi = document.getElementById('geri-bildirim-bekleyenler-listesi');
            const netigmaOnayBekleyenlerContainer = document.getElementById('netigma-onay-bekleyenler-container');
            const netigmaOnayBekleyenlerListesi = document.getElementById('netigma-onay-bekleyenler-listesi');
            const notesModal = document.getElementById('notes-modal');
            const closeNotesModalBtn = document.getElementById('close-notes-modal-btn');
            const notesTableBody = document.getElementById('notes-table-body');
            const downloadNotesExcelBtn = document.getElementById('download-notes-excel-btn');
            const approvalModal = document.getElementById('approval-modal');
            const closeApprovalModalBtn = document.getElementById('close-approval-modal-btn');
            const approvalModalTitle = document.getElementById('approval-modal-title');
            const approvalDateHeader = document.getElementById('approval-date-header');
            const approvalTableBody = document.getElementById('approval-table-body');
            const interactiveListContainer = document.getElementById('interactive-list-container');
            const performansRaporuCard = document.getElementById('performans-raporu-card');
            const performansRaporuModal = document.getElementById('performans-raporu-modal');
            const closePerformansRaporuModalBtn = document.getElementById('close-performans-raporu-modal-btn');
            const performansTableBody = document.getElementById('performans-table-body');
            const bolgeIadeCard = document.getElementById('bolge-iade-card');
            const bolgeIadeFileInput = document.getElementById('bolge-iade-file-input');
            const bolgeIadeModal = document.getElementById('bolge-iade-modal');
            const closeBolgeIadeModalBtn = document.getElementById('close-bolge-iade-modal-btn');
            const bolgeIadeTableBody = document.getElementById('bolge-iade-table-body');
            const isGeriBildirimCheck = document.getElementById('is-geri-bildirim-check');
            const geriBildirimTamamlandiContainer = document.getElementById('geri-bildirim-tamamlandi-container');
            const geriBildirimTamamlandiCheck = document.getElementById('geri-bildirim-tamamlandi-check');


            let taskData = [], personelFileSha = '';
            let currentDisplayData = [];
            const GITHUB_FILE_URL = 'https://api.github.com/repos/gokhangeo/mersin-th/contents/Personel.xlsx';
            
            async function loadTakipData() {
                 try {
                      loadingState.textContent = 'GitHub\'dan veriler okunuyor...';
                      const token = GITHUB_TOKEN_PARTS.join('');
                      const response = await fetch(GITHUB_FILE_URL, { headers: { 'Authorization': `token ${token}` } });
                      if (!response.ok) throw new Error('GitHub\'dan Personel verisi alÄ±namadÄ±.');
                      const fileData = await response.json();
                      personelFileSha = fileData.sha;
                      const fileContent = atob(fileData.content);
                      const workbook = XLSX.read(fileContent, { type: 'binary' });
                      taskData = [];
                      workbook.SheetNames.forEach(sheetName => {
                          const json = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
                          json.forEach(row => {
                              const mahalle = row['Mahalle AdÄ±'];
                              const personel = toTitleCase(row['GÃ–REVLÄ° PERSONEL']);
                              if (mahalle && personel) {
                                   const megsis = row['MEGSÄ°S ONAY TARÄ°HÄ°'] ? excelDateToJSDate(row['MEGSÄ°S ONAY TARÄ°HÄ°']) : '';
                                   const netigma = row['NETÄ°GMA ONAY TARÄ°HÄ°'] ? excelDateToJSDate(row['NETÄ°GMA ONAY TARÄ°HÄ°']) : '';
                                   const mudur = row['MÃœDÃœR ONAY'] ? excelDateToJSDate(row['MÃœDÃœR ONAY']) : '';
                                   const not = row['NOT'] || '';
                                   const not_tarihi = row['NOT_TARIHI'] ? excelDateToJSDate(row['NOT_TARIHI']) : '';
                                   taskData.push({ 
                                       ilce: sheetName, mahalle, personel, megsis, netigma, mudur, not, not_tarihi,
                                       isGeriBildirim: row['IS_GERI_BILDIRIM'] || false,
                                       geriBildirimTamamlandi: row['GERI_BILDIRIM_TAMAMLANDI'] || false
                                    });
                              }
                          });
                      });
                      populateTakipFilters();
                      applyFiltersAndRender();
                      if(loadingState && loadingState.parentElement) loadingState.parentElement.parentElement.remove();
                   } catch (error) {
                      console.error('Ä°ÅŸ Takip veri yÃ¼klenirken hata:', error);
                      if(loadingState) {
                          loadingState.textContent = "Veriler yÃ¼klenemedi.";
                          loadingState.classList.add('text-red-500');
                      }
                   }
            }
            function excelDateToJSDate(excelDate) {
                if(typeof excelDate === 'string' && (excelDate.includes('-') || excelDate.includes('.'))) return new Date(excelDate.replace(/\./g, '-')).toISOString().split('T')[0];
                if(typeof excelDate !== 'number') return '';
                const date = new Date((excelDate - 25569) * 86400 * 1000);
                return date.toISOString().split('T')[0];
            }
            async function saveDataToGitHub() {
                saveEntryBtn.disabled = true;
                saveEntryBtn.textContent = 'Kaydediliyor...';
                try {
                    const wb = XLSX.utils.book_new();
                    const ilceler = [...new Set(taskData.map(p => p.ilce))].sort((a,b) => a.localeCompare(b, 'tr'));
                    
                    ilceler.forEach(ilce => {
                        const sheetData = taskData
                            .filter(p => p.ilce === ilce)
                            .sort((a,b) => a.mahalle.localeCompare(b.mahalle, 'tr'))
                            .map(p => ({
                                'Mahalle AdÄ±': p.mahalle,
                                'GÃ–REVLÄ° PERSONEL': p.personel,
                                'MEGSÄ°S ONAY TARÄ°HÄ°': p.megsis || undefined,
                                'NETÄ°GMA ONAY TARÄ°HÄ°': p.netigma || undefined,
                                'MÃœDÃœR ONAY': p.mudur || undefined,
                                'NOT': p.not || undefined,
                                'NOT_TARIHI': p.not_tarihi || undefined,
                                'IS_GERI_BILDIRIM': p.isGeriBildirim || undefined,
                                'GERI_BILDIRIM_TAMAMLANDI': p.geriBildirimTamamlandi || undefined
                            }));
                        const ws = XLSX.utils.json_to_sheet(sheetData);
                        XLSX.utils.book_append_sheet(wb, ws, ilce);
                    });
                    const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'base64' });
                    const token = GITHUB_TOKEN_PARTS.join('');
                    const response = await fetch(GITHUB_FILE_URL, {
                        method: 'PUT',
                        headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: `[THA Sistemi] Veri GÃ¼ncelleme`, content: wbout, sha: personelFileSha })
                    });
                    if (!response.ok) throw new Error(await response.text());
                    alert('Veri baÅŸarÄ±yla GitHub\'a kaydedildi!');
                    await loadTakipData();
                } catch (error) {
                    console.error('Kaydetme hatasÄ±:', error);
                    alert(`Bir hata oluÅŸtu: ${error.message}`);
                } finally {
                    saveEntryBtn.disabled = false;
                    saveEntryBtn.textContent = 'Kaydet';
                    modal.classList.add('hidden');
                }
            }
            function populateTakipFilters() { 
                const ilceler = ['TÃ¼mÃ¼', ...[...new Set(taskData.map(p => p.ilce))].sort((a,b) => a.localeCompare(b, 'tr'))];
                const mahalleler = ['TÃ¼mÃ¼', ...[...new Set(taskData.map(p => p.mahalle))].sort((a,b) => a.localeCompare(b, 'tr'))];
                const personeller = ['TÃ¼mÃ¼', ...[...new Set(taskData.map(p => p.personel))].sort((a,b) => a.localeCompare(b, 'tr'))];

                ilceFilter.innerHTML = ilceler.map(i => `<option value="${i}">${i}</option>`).join('');
                mahalleFilter.innerHTML = mahalleler.map(m => `<option value="${m}">${m}</option>`).join('');
                personelFilter.innerHTML = personeller.map(p => `<option value="${p}">${p}</option>`).join('');
            }
            
            function applyFiltersAndRender() {
                const selectedIlce = ilceFilter.value;
                const selectedMahalle = mahalleFilter.value;
                const selectedPersonel = personelFilter.value;
                const searchTerm = hizliAramaInput.value.toLowerCase().trim();

                let filteredData = taskData;

                if (selectedIlce !== 'TÃ¼mÃ¼') {
                    filteredData = filteredData.filter(task => task.ilce === selectedIlce);
                }
                if (selectedMahalle !== 'TÃ¼mÃ¼') {
                    filteredData = filteredData.filter(task => task.mahalle === selectedMahalle);
                }
                if (selectedPersonel !== 'TÃ¼mÃ¼') {
                    filteredData = filteredData.filter(task => task.personel === selectedPersonel);
                }

                if (searchTerm) {
                    filteredData = filteredData.filter(task => 
                        task.ilce.toLowerCase().includes(searchTerm) ||
                        task.mahalle.toLowerCase().includes(searchTerm) ||
                        task.personel.toLowerCase().includes(searchTerm)
                    );
                }
                
                currentDisplayData = filteredData;

                renderTakipTable(currentDisplayData);
                renderInteractiveList(currentDisplayData);
                renderMegsisBekleyenler(taskData); 
                renderGeriBildirimBekleyenler(taskData);
                renderNetigmaOnayBekleyenler(taskData);
                updateSummaryCards(currentDisplayData);
            }

            function updateSummaryCards(dataToScan) {
                const todayString = new Date().toISOString().split('T')[0];
                
                const toplamMahalle = dataToScan.length;
                const megsisOnay = dataToScan.filter(task => task.megsis).length;
                const netigmaOnay = dataToScan.filter(task => task.netigma).length;
                const mudurOnay = dataToScan.filter(task => task.mudur).length;
                const notDÃ¼ÅŸÃ¼lenler = dataToScan.filter(task => task.not && task.not.trim() !== '').length;
                const netigmaBekleyen = dataToScan.filter(task => task.megsis && !task.netigma).length;
                const gununOlaylari = taskData.filter(task => task.megsis === todayString || task.netigma === todayString || task.mudur === todayString || task.not_tarihi === todayString).length;

                toplamMahalleCountEl.textContent = ilceFilter.value === 'TÃ¼mÃ¼' ? taskData.length : toplamMahalle;
                megsisOnayCountEl.textContent = megsisOnay;
                netigmaOnayCountEl.textContent = netigmaOnay;
                mudurOnayCountEl.textContent = mudurOnay;
                notCountEl.textContent = notDÃ¼ÅŸÃ¼lenler;
                netigmaBekleyenCountEl.textContent = netigmaBekleyen;
                gununOzetiCountEl.textContent = gununOlaylari;
            }

            function renderTakipTable(data) { 
                data.sort((a, b) => {
                    const aHasDate = a.megsis || a.netigma || a.mudur;
                    const bHasDate = b.megsis || b.netigma || b.mudur;
                    if (aHasDate && !bHasDate) return -1;
                    if (!aHasDate && bHasDate) return 1;
                    return a.ilce.localeCompare(b.ilce, 'tr-TR') || a.mahalle.localeCompare(b.mahalle, 'tr-TR');
                });

                if(data.length === 0){
                    taskTable.innerHTML = `<tr><td colspan="7" class="text-center p-8 text-gray-500">Filtreye uygun kayÄ±t bulunamadÄ±.</td></tr>`;
                } else {
                     taskTable.innerHTML = data.map((task) => `
                        <tr class="hover:bg-gray-50" data-task-ilce="${task.ilce}" data-task-mahalle="${task.mahalle}">
                            <td class="px-2 py-3 sm:px-6 sm:py-4 whitespace-nowrap text-xs sm:text-sm">${task.ilce}</td>
                            <td class="px-2 py-3 sm:px-6 sm:py-4 whitespace-nowrap text-xs sm:text-sm">${task.mahalle}</td>
                            <td class="px-2 py-3 sm:px-6 sm:py-4 whitespace-nowrap text-xs sm:text-sm">${task.personel}</td>
                            <td class="px-2 py-3 sm:px-6 sm:py-4 whitespace-nowrap text-xs sm:text-sm">${task.megsis || '-'}</td>
                            <td class="px-2 py-3 sm:px-6 sm:py-4 whitespace-nowrap text-xs sm:text-sm">${task.netigma || '-'}</td>
                            <td class="px-2 py-3 sm:px-6 sm:py-4 whitespace-nowrap text-xs sm:text-sm">${task.mudur || '-'}</td>
                            <td class="px-2 py-3 sm:px-6 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-500 truncate max-w-xs" title="${task.not || ''}">${task.not || '-'}</td>
                        </tr>`).join('');
                }
                 document.querySelectorAll('#task-table tr').forEach(row => {
                      row.addEventListener('click', () => openEditModal(row.dataset.taskIlce, row.dataset.taskMahalle));
                   });
            }
            
            function renderInteractiveList(data) {
                const groupedByIlce = data.reduce((acc, task) => {
                    (acc[task.ilce] = acc[task.ilce] || []).push(task);
                    return acc;
                }, {});

                const ilceNames = Object.keys(groupedByIlce).sort((a,b) => a.localeCompare(b, 'tr'));

                let html = '';
                for (const ilce of ilceNames) {
                    const allMahallelerForIlce = taskData.filter(t => t.ilce === ilce);
                    const totalCount = allMahallelerForIlce.length;
                    const completedCount = allMahallelerForIlce.filter(m => m.megsis && m.netigma && m.mudur).length;
                    const percentage = totalCount > 0 ? (completedCount / totalCount) * 100 : 0;
                    
                    const mahallelerToShow = groupedByIlce[ilce];
                    mahallelerToShow.sort((a, b) => {
                        const countA = (a.megsis ? 1 : 0) + (a.netigma ? 1 : 0) + (a.mudur ? 1 : 0);
                        const countB = (b.megsis ? 1 : 0) + (b.netigma ? 1 : 0) + (b.mudur ? 1 : 0);

                        if (countA !== countB) { return countB - countA; }
                        return a.mahalle.localeCompare(b.mahalle, 'tr');
                    });

                    const checkIcon = (hasDate) => `<svg class="w-5 h-5 ${hasDate ? 'text-green-500' : 'text-gray-300'}" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>`;

                    html += `
                        <div class="bg-white rounded-lg shadow border border-gray-200">
                            <div class="ilce-header flex justify-between items-center p-3 cursor-pointer hover:bg-gray-50">
                                <div class="flex-grow mr-4">
                                    <span class="font-bold text-gray-700">${ilce}</span>
                                    <div class="w-full bg-gray-200 rounded-full h-2 mt-1" title="${percentage.toFixed(0)}% TamamlandÄ±">
                                        <div class="bg-blue-600 h-2 rounded-full" style="width: ${percentage}%"></div>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-2 flex-shrink-0">
                                    <span class="text-sm font-semibold text-blue-600">${completedCount} / ${totalCount}</span>
                                    <span class="arrow text-gray-500">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                    </span>
                                </div>
                            </div>
                            <div class="mahalle-list hidden border-t border-gray-200 p-2 text-sm space-y-2 bg-gray-50" style="max-height: 300px; overflow-y: auto;">
                                ${mahallelerToShow.map(m => `
                                    <div class="mahalle-item p-2 rounded hover:bg-gray-100 cursor-pointer" data-ilce="${ilce}" data-mahalle="${m.mahalle}">
                                        <div class="flex justify-between items-center">
                                            <span class="font-semibold text-gray-800">${m.mahalle}</span>
                                            <div class="flex space-x-1" title="MGS / NTG / MDR">
                                                ${checkIcon(m.megsis)}
                                                ${checkIcon(m.netigma)}
                                                ${checkIcon(m.mudur)}
                                            </div>
                                        </div>
                                        <div class="text-xs text-gray-500 mt-1">${m.personel}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
                interactiveListContainer.innerHTML = html;

                document.querySelectorAll('.ilce-header').forEach(header => {
                    header.addEventListener('click', () => {
                        header.classList.toggle('open');
                        const content = header.nextElementSibling;
                        content.classList.toggle('hidden');
                    });
                });

                document.querySelectorAll('.mahalle-item').forEach(item => {
                    item.addEventListener('click', () => {
                        openEditModal(item.dataset.ilce, item.dataset.mahalle);
                    });
                });
            }
            
            function renderMegsisBekleyenler(data) {
                const bekleyenler = data.filter(task => task.not && task.not.trim() !== '' && !task.megsis);

                if (bekleyenler.length === 0) {
                    mefsisBekleyenlerContainer.classList.add('hidden');
                    return;
                }

                mefsisBekleyenlerContainer.classList.remove('hidden');
                
                mefsisBekleyenlerListesi.innerHTML = bekleyenler.map(task => `
                    <div class="megsis-bekleyen-item cursor-pointer bg-red-100 text-red-800 text-sm px-3 py-2 rounded-lg animate-blink flex flex-col items-center"
                          data-ilce="${task.ilce}" data-mahalle="${task.mahalle}">
                        <span class="text-xs font-semibold text-red-700">${task.ilce}</span>
                        <span class="font-bold">${task.mahalle}</span>
                        <span class="text-xs text-red-600">(${task.personel})</span>
                    </div>
                `).join('');

                document.querySelectorAll('.megsis-bekleyen-item').forEach(item => {
                    item.addEventListener('click', () => {
                        openEditModal(item.dataset.ilce, item.dataset.mahalle);
                    });
                });
            }

             function renderGeriBildirimBekleyenler(data) {
                const bekleyenler = data.filter(task => task.isGeriBildirim && !task.geriBildirimTamamlandi);

                if (bekleyenler.length === 0) {
                    geriBildirimBekleyenlerContainer.classList.add('hidden');
                    return;
                }

                geriBildirimBekleyenlerContainer.classList.remove('hidden');
                
                geriBildirimBekleyenlerListesi.innerHTML = bekleyenler.map(task => `
                    <div class="geri-bildirim-bekleyen-item cursor-pointer bg-blue-100 text-blue-800 text-sm px-3 py-2 rounded-lg animate-blink flex flex-col items-center"
                          data-ilce="${task.ilce}" data-mahalle="${task.mahalle}">
                        <span class="text-xs font-semibold text-blue-700">${task.ilce}</span>
                        <span class="font-bold">${task.mahalle}</span>
                        <span class="text-xs text-blue-600">(${task.personel})</span>
                    </div>
                `).join('');

                document.querySelectorAll('.geri-bildirim-bekleyen-item').forEach(item => {
                    item.addEventListener('click', () => {
                        openEditModal(item.dataset.ilce, item.dataset.mahalle);
                    });
                });
            }

             function renderNetigmaOnayBekleyenler(data) {
                const bekleyenler = data.filter(task => task.megsis && !task.netigma);

                if (bekleyenler.length === 0) {
                    netigmaOnayBekleyenlerContainer.classList.add('hidden');
                    return;
                }

                netigmaOnayBekleyenlerContainer.classList.remove('hidden');
                
                netigmaOnayBekleyenlerListesi.innerHTML = bekleyenler.map(task => `
                    <div class="netigma-onay-bekleyen-item cursor-pointer bg-green-100 text-green-800 text-sm px-3 py-2 rounded-lg animate-blink flex flex-col items-center"
                            data-ilce="${task.ilce}" data-mahalle="${task.mahalle}">
                        <span class="text-xs font-semibold text-green-700">${task.ilce}</span>
                        <span class="font-bold">${task.mahalle}</span>
                        <span class="text-xs text-green-600">(${task.personel})</span>
                    </div>
                `).join('');

                document.querySelectorAll('.netigma-onay-bekleyen-item').forEach(item => {
                    item.addEventListener('click', () => {
                        openEditModal(item.dataset.ilce, item.dataset.mahalle);
                    });
                });
            }

            function openEditModal(ilce, mahalle) {
                if (!ilce || !mahalle) return;
                const task = taskData.find(t => t.ilce === ilce && t.mahalle === mahalle);
                if (!task) return;

                modalTitle.textContent = `Ä°ÅŸ GiriÅŸini DÃ¼zenle`;
                
                modalIlce.innerHTML = `<option value="${task.ilce}">${task.ilce}</option>`;
                modalIlce.value = task.ilce;
                modalIlce.disabled = true;

                modalMahalle.innerHTML = `<option value="${task.mahalle}">${task.mahalle}</option>`;
                modalMahalle.value = task.mahalle;
                modalMahalle.disabled = true;

                modalPersonel.value = task.personel;
                megsisDate.value = task.megsis || '';
                netigmaDate.value = task.netigma || '';
                mudurDate.value = task.mudur || '';
                modalNot.value = task.not || '';
                notTarihiInput.value = task.not_tarihi || '';
                isGeriBildirimCheck.checked = task.isGeriBildirim || false;
                geriBildirimTamamlandiCheck.checked = task.geriBildirimTamamlandi || false;

                if (task.not && task.not.trim() !== '') {
                    notTarihiContainer.classList.remove('hidden');
                } else {
                    notTarihiContainer.classList.add('hidden');
                }
                
                if (isGeriBildirimCheck.checked) {
                    geriBildirimTamamlandiContainer.classList.remove('hidden');
                } else {
                    geriBildirimTamamlandiContainer.classList.add('hidden');
                }

                modal.classList.remove('hidden');
            }

            function openGununOzetiModal() {
                const todayString = new Date().toISOString().split('T')[0];
                const todaysEntries = taskData.filter(task => task.megsis === todayString || task.netigma === todayString || task.mudur === todayString || task.not_tarihi === todayString);

                if (todaysEntries.length === 0) {
                    gununOzetiTableBody.innerHTML = `<tr><td colspan="4" class="text-center p-8 text-gray-500">BugÃ¼n herhangi bir iÅŸlem yapÄ±lmadÄ±.</td></tr>`;
                } else {
                    gununOzetiTableBody.innerHTML = todaysEntries.map(task => {
                        let islemler = [];
                        if (task.megsis === todayString) islemler.push('<span class="bg-green-100 text-green-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded">Megsis OnayÄ±</span>');
                        if (task.netigma === todayString) islemler.push('<span class="bg-blue-100 text-blue-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded">Netigma OnayÄ±</span>');
                        if (task.mudur === todayString) islemler.push('<span class="bg-purple-100 text-purple-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded">MÃ¼dÃ¼r OnayÄ±</span>');
                        if (task.not_tarihi === todayString) islemler.push('<span class="bg-yellow-100 text-yellow-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded">Not Eklendi/GÃ¼ncellendi</span>');
                        
                        return `
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 whitespace-nowrap">${task.ilce}</td>
                                <td class="px-6 py-4 whitespace-nowrap">${task.mahalle}</td>
                                <td class="px-6 py-4 whitespace-nowrap">${task.personel}</td>
                                <td class="px-6 py-4 whitespace-nowrap">${islemler.join(' ')}</td>
                            </tr>
                        `;
                    }).join('');
                }
                gununOzetiModal.classList.remove('hidden');
            }

            function downloadGununOzetiExcel() {
                const todayString = new Date().toISOString().split('T')[0];
                const todaysEntries = taskData.filter(task => task.megsis === todayString || task.netigma === todayString || task.mudur === todayString || task.not_tarihi === todayString);

                if (todaysEntries.length === 0) {
                    alert('DÄ±ÅŸa aktarÄ±lacak bugÃ¼nkÃ¼ iÅŸlem bulunmuyor.');
                    return;
                }

                const dataToExport = todaysEntries.map(task => {
                    let islemler = [];
                    if (task.megsis === todayString) islemler.push('Megsis OnayÄ±');
                    if (task.netigma === todayString) islemler.push('Netigma OnayÄ±');
                    if (task.mudur === todayString) islemler.push('MÃ¼dÃ¼r OnayÄ±');
                    if (task.not_tarihi === todayString) islemler.push('Not Eklendi/GÃ¼ncellendi');
                    
                    return {
                        'Ä°lÃ§e': task.ilce,
                        'Mahalle': task.mahalle,
                        'Personel': task.personel,
                        'YapÄ±lan Ä°ÅŸlem': islemler.join(', ')
                    };
                });
                
                const ws = XLSX.utils.json_to_sheet(dataToExport);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'GÃ¼nÃ¼n Ã–zeti');
                XLSX.writeFile(wb, `gunun_ozeti_${todayString}.xlsx`);
            }
            
            function generatePerformanceReport(period = 'all') {
                const now = new Date();
                const startOfWeek = new Date(now);
                startOfWeek.setDate(startOfWeek.getDate() - (startOfWeek.getDay() + 6) % 7); // Monday
                startOfWeek.setHours(0,0,0,0);
                
                const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                startOfMonth.setHours(0,0,0,0);

                const personeller = [...new Set(taskData.map(p => p.personel))].sort();
                const stats = {};

                personeller.forEach(p => {
                    const personTasks = taskData.filter(t => t.personel === p);

                    // Calculate all-time stats
                    const megsisDates = personTasks
                        .map(t => t.megsis)
                        .filter(d => d)
                        .map(d => new Date(d))
                        .sort((a, b) => a - b);
                    
                    const completedCount = personTasks.filter(t => t.megsis && t.netigma && t.mudur).length;
                    
                    let avgWorkDaysPerUnit = '0.0'; // Default to 0.0
                    if (megsisDates.length > 0 && completedCount > 0) {
                        const firstMegsisDate = megsisDates[0];
                        const today = new Date();
                        const workDays = calculateWorkDays(firstMegsisDate, today);
                        
                        if (workDays > 0) {
                            avgWorkDaysPerUnit = (completedCount / workDays).toFixed(2); // New logic: Units / Day
                        } else if (completedCount > 0 && workDays === 0) {
                             avgWorkDaysPerUnit = '-'; // TamamlandÄ± ama iÅŸ gÃ¼nÃ¼ 0, tanÄ±msÄ±z
                        }
                    }

                    // Calculate period-specific stats
                    const megsisInPeriod = personTasks.filter(t => {
                        if (!t.megsis) return false;
                        if (period === 'all') return true;
                        const date = new Date(t.megsis);
                        if (period === 'week') return date >= startOfWeek;
                        if (period === 'month') return date >= startOfMonth;
                    }).length;
                    
                    const netigmaInPeriod = personTasks.filter(t => {
                        if (!t.netigma) return false;
                        if (period === 'all') return true;
                        const date = new Date(t.netigma);
                        if (period === 'week') return date >= startOfWeek;
                        if (period === 'month') return date >= startOfMonth;
                    }).length;

                    const mudurInPeriod = personTasks.filter(t => {
                        if (!t.mudur) return false;
                        if (period === 'all') return true;
                        const date = new Date(t.mudur);
                        if (period === 'week') return date >= startOfWeek;
                        if (period === 'month') return date >= startOfMonth;
                    }).length;

                    stats[p] = {
                        toplamGorev: personTasks.length,
                        megsis: megsisInPeriod, 
                        netigma: netigmaInPeriod, 
                        mudur: mudurInPeriod,
                        tamamlanan: completedCount,
                        avgWorkDays: avgWorkDaysPerUnit
                    };
                });
                
                performansTableBody.innerHTML = Object.entries(stats).map(([personel, data]) => `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900">${personel}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${data.toplamGorev}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${data.megsis}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${data.netigma}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${data.mudur}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${data.tamamlanan}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${data.avgWorkDays}</td> 
                    </tr>
                `).join('');
                
                document.querySelectorAll('#performans-raporu-modal .period-btn').forEach(btn => {
                    btn.classList.remove('bg-blue-600', 'text-white');
                    btn.classList.add('bg-gray-200', 'text-gray-700');
                    if (btn.dataset.period === period) {
                        btn.classList.add('bg-blue-600', 'text-white');
                        btn.classList.remove('bg-gray-200', 'text-gray-700');
                    }
                });

                performansRaporuModal.classList.remove('hidden');
            }

            function handleIadeFile(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const json = XLSX.utils.sheet_to_json(worksheet);

                    const bolgedeKalanlar = new Set();
                    json.forEach(row => {
                        const ilce = row['Ä°lÃ§e'] ? String(row['Ä°lÃ§e']).trim().toLocaleUpperCase('tr-TR') : '';
                        const mahalle = row['Mahalle'] ? String(row['Mahalle']).trim().toLocaleUpperCase('tr-TR') : '';
                        if (ilce && mahalle) {
                            bolgedeKalanlar.add(`${ilce}-${mahalle}`);
                        }
                    });

                    const mudurOnayliListesi = taskData.filter(task => task.mudur);

                    const iadeEdilenler = mudurOnayliListesi.filter(task => {
                        const identifier = `${task.ilce.toLocaleUpperCase('tr-TR')}-${task.mahalle.toLocaleUpperCase('tr-TR')}`;
                        return !bolgedeKalanlar.has(identifier);
                    });

                    openIadeRaporuModal(iadeEdilenler);

                    event.target.value = '';
                };
                reader.readAsArrayBuffer(file);
            }

            function openIadeRaporuModal(iadeListesi) {
                if (iadeListesi.length === 0) {
                    bolgeIadeTableBody.innerHTML = `<tr><td colspan="4" class="text-center p-8 text-gray-500">BÃ¶lgeden iade edilen iÅŸlem bulunamadÄ±. MÃ¼dÃ¼r onaylÄ± tÃ¼m iÅŸlemler bÃ¶lgede bekliyor.</td></tr>`;
                } else {
                    bolgeIadeTableBody.innerHTML = iadeListesi.map(task => `
                        <tr class="hover:bg-gray-50 cursor-pointer" data-ilce="${task.ilce}" data-mahalle="${task.mahalle}">
                            <td class="px-6 py-4 whitespace-nowrap">${task.ilce}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${task.mahalle}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${task.personel}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${task.mudur}</td>
                        </tr>
                    `).join('');
                    
                    document.querySelectorAll('#bolge-iade-table-body tr').forEach(row => {
                        row.addEventListener('click', () => {
                            bolgeIadeModal.classList.add('hidden');
                            openEditModal(row.dataset.ilce, row.dataset.mahalle);
                        });
                    });
                }
                bolgeIadeModal.classList.remove('hidden');
            }


            function renderNotesModal() {
                const notedTasks = taskData.filter(task => task.not && task.not.trim() !== '').sort((a,b) => (b.not_tarihi || '').localeCompare(a.not_tarihi || ''));
                notesTableBody.innerHTML = '';
                if (notedTasks.length === 0) {
                    notesTableBody.innerHTML = `<tr><td colspan="6" class="text-center p-8 text-gray-500">Not dÃ¼ÅŸÃ¼len birim bulunamadÄ±.</td></tr>`;
                } else {
                    notesTableBody.innerHTML = notedTasks.map(task => {
                         let statusHtml = '';
                        if (task.isGeriBildirim) {
                            if (task.geriBildirimTamamlandi) {
                                statusHtml = `<span title="Geri Bildirim TamamlandÄ±"><svg class="w-6 h-6 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg></span>`;
                            } else {
                                statusHtml = `<span title="Geri Bildirim Notu"><svg class="w-6 h-6 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg></span>`;
                            }
                        }
                        return `
                        <tr class="hover:bg-gray-50 cursor-pointer" data-ilce="${task.ilce}" data-mahalle="${task.mahalle}">
                            <td class="px-6 py-4 whitespace-nowrap">${statusHtml}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${task.ilce}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${task.mahalle}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${task.personel}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${task.not_tarihi || '-'}</td>
                            <td class="px-6 py-4 whitespace-normal text-sm text-gray-700">${task.not}</td>
                        </tr>
                    `}).join('');

                    document.querySelectorAll('#notes-table-body tr[data-ilce]').forEach(row => {
                        row.addEventListener('click', () => {
                            notesModal.classList.add('hidden');
                            openEditModal(row.dataset.ilce, row.dataset.mahalle);
                        });
                    });
                }
                notesModal.classList.remove('hidden');
            }

            function downloadNotesExcel() {
                const notedTasks = taskData.filter(task => task.not && task.not.trim() !== '').sort((a,b) => (b.not_tarihi || '').localeCompare(a.not_tarihi || ''));
                const dataToExport = notedTasks.map(row => ({
                    'Ä°lÃ§e': row.ilce, 'Mahalle': row.mahalle, 'GÃ¶revli Personel': row.personel, 'Not Tarihi': row.not_tarihi, 'Not': row.not, 'Geri Bildirim?': row.isGeriBildirim, 'GB TamamlandÄ±?': row.geriBildirimTamamlandi
                }));

                if(dataToExport.length === 0){ alert('DÄ±ÅŸa aktarÄ±lacak not bulunmuyor.'); return; }

                const ws = XLSX.utils.json_to_sheet(dataToExport);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Not Raporu');
                XLSX.writeFile(wb, 'not_raporu.xlsx');
            }
            
            function openApprovalModal(approvalType) {
                let title = '', header = '', approvedTasks;
                switch (approvalType) {
                    case 'megsis':
                        title = 'Megsis OnayÄ± Olan Birimler';
                        header = 'Megsis Onay Tarihi';
                        approvedTasks = currentDisplayData.filter(task => task.megsis).sort((a, b) => b.megsis.localeCompare(a.megsis));
                        break;
                    case 'netigmaBekleyen':
                        title = 'Netigma OnayÄ± Bekleyenler';
                        header = 'Megsis Onay Tarihi';
                        approvedTasks = currentDisplayData.filter(task => task.megsis && !task.netigma).sort((a, b) => b.megsis.localeCompare(a.megsis));
                        break;
                    case 'netigma':
                        title = 'Netigma OnayÄ± Olan Birimler';
                        header = 'Netigma Onay Tarihi';
                        approvedTasks = currentDisplayData.filter(task => task.netigma).sort((a, b) => b.netigma.localeCompare(a.netigma));
                        break;
                    case 'mudur':
                        title = 'MÃ¼dÃ¼r OnayÄ± Olan Birimler';
                        header = 'MÃ¼dÃ¼r Onay Tarihi';
                        approvedTasks = currentDisplayData.filter(task => task.mudur).sort((a, b) => b.mudur.localeCompare(a.mudur));
                        break;
                }
                approvalModalTitle.textContent = title;
                approvalDateHeader.textContent = header;

                
                approvalTableBody.innerHTML = approvedTasks.length === 0 ? `<tr><td colspan="4" class="text-center p-8 text-gray-500">Bu kritere uygun birim bulunamadÄ±.</td></tr>` : approvedTasks.map(task => `
                    <tr class="hover:bg-gray-50 cursor-pointer" data-task-ilce="${task.ilce}" data-task-mahalle="${task.mahalle}">
                        <td class="px-6 py-4 whitespace-nowrap">${task.ilce}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${task.mahalle}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${task.personel}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${task[approvalType === 'netigmaBekleyen' ? 'megsis' : approvalType]}</td>
                    </tr>
                `).join('');

                document.querySelectorAll('#approval-table-body tr[data-task-ilce]').forEach(row => {
                    row.addEventListener('click', () => {
                        approvalModal.classList.add('hidden');
                        openEditModal(row.dataset.taskIlce, row.dataset.taskMahalle);
                    });
                });
                approvalModal.classList.remove('hidden');
            }

            async function init() {
                if(isLoaded) return;
                isLoaded = true;
                await loadTakipData();
                
                ilceFilter.addEventListener('change', () => {
                     const selectedIlce = ilceFilter.value;
                     const mahalleler = ['TÃ¼mÃ¼', ...[...new Set(taskData.filter(p => selectedIlce === 'TÃ¼mÃ¼' || p.ilce === selectedIlce).map(p => p.mahalle))].sort((a,b) => a.localeCompare(b, 'tr'))];
                     mahalleFilter.innerHTML = mahalleler.map(m => `<option value="${m}">${m}</option>`).join('');
                     applyFiltersAndRender();
                });
                mahalleFilter.addEventListener('change', applyFiltersAndRender);
                personelFilter.addEventListener('change', applyFiltersAndRender);
                hizliAramaInput.addEventListener('input', applyFiltersAndRender);

                addEntryBtn.addEventListener('click', () => {
                    modalTitle.textContent = 'Yeni Ä°ÅŸ GiriÅŸi';
                    modalIlce.disabled = false;
                    modalMahalle.disabled = false;
                    const ilceler = [...new Set(taskData.map(p => p.ilce))].sort((a,b) => a.localeCompare(b, 'tr'));
                    modalIlce.innerHTML = `<option value="">Ä°lÃ§e SeÃ§in</option>` + ilceler.map(i => `<option value="${i}">${i}</option>`).join('');
                    modalMahalle.innerHTML = `<option value="">Ã–nce Ä°lÃ§e SeÃ§in</option>`;
                    modalPersonel.value = '';
                    megsisDate.value = '';
                    netigmaDate.value = '';
                    mudurDate.value = '';
                    modalNot.value = '';
                    notTarihiInput.value = '';
                    notTarihiContainer.classList.add('hidden');
                    isGeriBildirimCheck.checked = false;
                    geriBildirimTamamlandiCheck.checked = false;
                    geriBildirimTamamlandiContainer.classList.add('hidden');
                    modal.classList.remove('hidden');
                });
                modalIlce.addEventListener('change', () => {
                     const selectedIlce = modalIlce.value;
                     const mahalleler = [...new Set(taskData.filter(p => p.ilce === selectedIlce).map(p => p.mahalle))].sort((a,b) => a.localeCompare(b, 'tr'));
                     modalMahalle.innerHTML = `<option value="">Mahalle SeÃ§in</option>` + mahalleler.map(m => `<option value="${m}">${m}</option>`).join('');
                     modalPersonel.value = '';
                     megsisDate.value = '';
                     netigmaDate.value = '';
                     mudurDate.value = '';
                     modalNot.value = '';
                     notTarihiInput.value = '';
                     notTarihiContainer.classList.add('hidden');
                });
                modalMahalle.addEventListener('change', () => {
                    const selectedIlce = modalIlce.value;
                    const selectedMahalle = modalMahalle.value;
                    const gorevli = taskData.find(p => p.ilce === selectedIlce && p.mahalle === selectedMahalle);
                    
                    if (gorevli) {
                        openEditModal(gorevli.ilce, gorevli.mahalle);
                    } else {
                        modalPersonel.value = 'AtanmamÄ±ÅŸ';
                        megsisDate.value = ''; netigmaDate.value = ''; mudurDate.value = ''; modalNot.value = ''; notTarihiInput.value = '';
                        notTarihiContainer.classList.add('hidden');
                    }
                });

                modalNot.addEventListener('input', () => {
                    if (modalNot.value.trim() !== '') {
                        notTarihiContainer.classList.remove('hidden');
                        if (!notTarihiInput.value) {
                            notTarihiInput.value = new Date().toISOString().split('T')[0];
                        }
                    } else {
                        notTarihiContainer.classList.add('hidden');
                        notTarihiInput.value = '';
                    }
                });

                isGeriBildirimCheck.addEventListener('change', () => {
                    if (isGeriBildirimCheck.checked) {
                        geriBildirimTamamlandiContainer.classList.remove('hidden');
                    } else {
                        geriBildirimTamamlandiContainer.classList.add('hidden');
                        geriBildirimTamamlandiCheck.checked = false; 
                    }
                });

                cancelBtn.addEventListener('click', () => modal.classList.add('hidden'));

                saveEntryBtn.addEventListener('click', () => {
                    const ilce = modalIlce.value, mahalle = modalMahalle.value, not = modalNot.value, not_tarihi = notTarihiInput.value;
                    if (!ilce || !mahalle) { alert('LÃ¼tfen ilÃ§e ve mahalle seÃ§in.'); return; }
                    let task = taskData.find(t => t.ilce === ilce && t.mahalle === mahalle);
                    if (task) { 
                        task.megsis = megsisDate.value; task.netigma = netigmaDate.value; task.mudur = mudurDate.value; task.not = not;
                        task.not_tarihi = not.trim() === '' ? '' : not_tarihi;
                        task.isGeriBildirim = isGeriBildirimCheck.checked;
                        task.geriBildirimTamamlandi = geriBildirimTamamlandiCheck.checked;
                    } else {
                         task = { ilce, mahalle, personel: modalPersonel.value, megsis: megsisDate.value, netigma: netigmaDate.value, mudur: mudurDate.value, not: not, not_tarihi: not.trim() === '' ? '' : not_tarihi, isGeriBildirim: isGeriBildirimCheck.checked, geriBildirimTamamlandi: geriBildirimTamamlandiCheck.checked };
                        taskData.push(task);
                    }
                    saveDataToGitHub();
                });
                
                downloadTakipExcelBtn.addEventListener('click', () => {
                    const dataToExport = currentDisplayData.map(row => ({
                        'Ä°lÃ§e': row.ilce, 'Mahalle': row.mahalle, 'GÃ¶revli Personel': row.personel, 'Megsis Onay': row.megsis,
                        'Netigma Onay': row.netigma, 'MÃ¼dÃ¼r Onay': row.mudur, 'Not Tarihi': row.not_tarihi, 'Not': row.not,
                        'Geri Bildirim?': row.isGeriBildirim, 'GB TamamlandÄ±?': row.geriBildirimTamamlandi
                    }));
                    const ws = XLSX.utils.json_to_sheet(dataToExport);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, 'Ä°ÅŸ Takip Raporu');
                    XLSX.writeFile(wb, 'is_takip_raporu.xlsx');
                });

                performansRaporuCard.addEventListener('click', () => generatePerformanceReport('all'));
                closePerformansRaporuModalBtn.addEventListener('click', () => performansRaporuModal.classList.add('hidden'));
                document.querySelectorAll('#performans-raporu-modal .period-btn').forEach(btn => {
                    btn.addEventListener('click', () => generatePerformanceReport(btn.dataset.period));
                });

                gununOzetiCard.addEventListener('click', openGununOzetiModal);
                closeGununOzetiModalBtn.addEventListener('click', () => gununOzetiModal.classList.add('hidden'));
                downloadGununOzetiExcelBtn.addEventListener('click', downloadGununOzetiExcel);
                notCard.addEventListener('click', renderNotesModal);
                closeNotesModalBtn.addEventListener('click', () => notesModal.classList.add('hidden'));
                downloadNotesExcelBtn.addEventListener('click', downloadNotesExcel);
                bolgeIadeCard.addEventListener('click', () => bolgeIadeFileInput.click());
                bolgeIadeFileInput.addEventListener('change', handleIadeFile);
                closeBolgeIadeModalBtn.addEventListener('click', () => bolgeIadeModal.classList.add('hidden'));
                
                megsisCard.addEventListener('click', () => openApprovalModal('megsis'));
                netigmaBekleyenCard.addEventListener('click', () => openApprovalModal('netigmaBekleyen'));
                netigmaCard.addEventListener('click', () => openApprovalModal('netigma'));
                mudurCard.addEventListener('click', () => openApprovalModal('mudur'));
                closeApprovalModalBtn.addEventListener('click', () => approvalModal.classList.add('hidden'));
            }
            return init;
        })();
    });
    </script>
</body>
</html>

