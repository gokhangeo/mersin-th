<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mersin İli THA Analizi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Excel dosyalarını okumak için SheetJS kütüphanesi -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Chart.js Kütüphanesi -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .table-container {
            max-height: 60vh;
            overflow-y: auto;
        }
        /* Custom scrollbar for better aesthetics */
        .table-container::-webkit-scrollbar {
            width: 8px;
        }
        .table-container::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .table-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        .table-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        th .sort-icon {
            opacity: 0.3;
            transition: opacity 0.2s;
        }
        th:hover .sort-icon {
            opacity: 0.7;
        }
        th .sort-icon.active {
            opacity: 1;
            color: #2563eb;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        
        <!-- Başlık Bölümü -->
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-700">MERSİN İLİ THA ANALİZİ</h1>
            <p class="text-gray-600 mt-2 text-sm">© Gökhan ELGÜL tarafından tasarlanmıştır.</p>
            <p class="text-gray-500 mt-2">İlçe seçerek arazi niteliklerini arayın, filtreleyin ve özet bilgileri görüntüleyin.</p>
        </header>

        <!-- Filtreleme ve Özet Kartları -->
        <div class="mb-6 grid grid-cols-1 md:grid-cols-5 gap-6 items-end">
            <!-- İlçe Seçimi -->
            <div class="bg-white p-4 rounded-xl shadow-md">
                <label for="ilce-select" class="block text-sm font-medium text-gray-600 mb-2">İlçe Seçin:</label>
                <select id="ilce-select" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition" disabled></select>
            </div>
             <!-- Arama Kutusu -->
            <div class="bg-white p-4 rounded-xl shadow-md">
                <label for="search-input" class="block text-sm font-medium text-gray-600 mb-2">Nitelik Ara:</label>
                <input type="text" id="search-input" placeholder="Örn: Orman, TEOY..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition" disabled>
            </div>
            <!-- İlçe Toplamları -->
            <div class="md:col-span-1 bg-white p-4 rounded-xl shadow-md flex flex-col justify-center text-center">
                <h3 class="text-lg font-semibold text-blue-600">Seçili Alan Dağılımı</h3>
                <div class="mt-2">
                    <span class="text-sm text-green-600">Ekonomik Değeri Olan</span>
                    <p id="ekonomik-var-ilce-toplam" class="text-xl font-bold text-gray-800">0 m²</p>
                </div>
                <div class="mt-2 border-t pt-2">
                    <span class="text-sm text-red-600">Ekonomik Değeri Olmayan</span>
                    <p id="ekonomik-yok-ilce-toplam" class="text-xl font-bold text-gray-800">0 m²</p>
                </div>
            </div>
            <!-- Dinamik Toplam -->
            <div class="md:col-span-1 bg-white p-4 rounded-xl shadow-md flex flex-col justify-center text-center">
                <h3 id="toplam-kart-baslik" class="text-lg font-semibold text-indigo-600">Mersin Genel Toplam</h3>
                <p id="genel-toplam" class="text-2xl font-bold text-gray-800 mt-2">0 m²</p>
            </div>
            <!-- Butonlar -->
            <div class="bg-white p-4 rounded-xl shadow-md flex flex-col justify-center text-center space-y-2">
                 <button id="toggle-chart" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition disabled:bg-gray-400" disabled>
                    Grafikleri Göster/Gizle
                </button>
                <button id="download-excel" class="w-full bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 transition disabled:bg-gray-400" disabled>
                    Excel Olarak İndir
                </button>
            </div>
        </div>
        
        <!-- Grafik Bölümü -->
        <div id="chart-container" class="bg-white rounded-xl shadow-md p-4 mb-6 hidden">
             <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 items-center">
                <div class="relative h-96">
                    <h2 class="text-xl font-bold text-center text-gray-700 mb-4">Nitelik Bazlı Alan Dağılımı</h2>
                    <canvas id="nitelikBarChart"></canvas>
                </div>
                <div class="relative h-96">
                    <h2 class="text-xl font-bold text-center text-gray-700 mb-4">İlçe Bazlı Karşılaştırma</h2>
                    <canvas id="ilceBarChart"></canvas>
                </div>
             </div>
        </div>

        <!-- Tablo Bölümü -->
        <div class="bg-white rounded-xl shadow-md overflow-hidden">
            <div class="table-container">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-100 sticky top-0">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Nitelik</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Kod</th>
                            <th scope="col" class="px-6 py-3 text-right text-xs font-bold text-gray-600 uppercase tracking-wider cursor-pointer" data-sort-by="adet">
                                <div class="flex items-center justify-end">
                                    <span>Adet</span>
                                    <svg class="w-4 h-4 ml-1 sort-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l4-4 4 4m0 6l-4 4-4-4"></path></svg>
                                </div>
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider cursor-pointer" data-sort-by="ekonomikDegeri">
                                <div class="flex items-center">
                                    <span>Ekonomik Değeri</span>
                                    <svg class="w-4 h-4 ml-1 sort-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l4-4 4 4m0 6l-4 4-4-4"></path></svg>
                                </div>
                            </th>
                            <th scope="col" class="px-6 py-3 text-right text-xs font-bold text-gray-600 uppercase tracking-wider cursor-pointer" data-sort-by="yuzolcumM2">
                                <div class="flex items-center justify-end">
                                    <span>Yüzölçüm (m²)</span>
                                    <svg class="w-4 h-4 ml-1 sort-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l4-4 4 4m0 6l-4 4-4-4"></path></svg>
                                </div>
                            </th>
                            <th scope="col" class="px-6 py-3 text-right text-xs font-bold text-gray-600 uppercase tracking-wider cursor-pointer" data-sort-by="yuzolcumHa">
                                <div class="flex items-center justify-end">
                                    <span>Yüzölçüm (ha)</span>
                                    <svg class="w-4 h-4 ml-1 sort-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l4-4 4 4m0 6l-4 4-4-4"></path></svg>
                                </div>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="data-table" class="bg-white divide-y divide-gray-200">
                        <!-- Veriler JavaScript ile buraya eklenecek -->
                        <tr>
                            <td colspan="6" class="px-6 py-12 text-center text-gray-500">
                                <div id="loading-state">GitHub'dan veriler yükleniyor...</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <footer class="text-center mt-8 text-sm text-gray-400">
            <p>Gökhan GEÇİT | Harita Mühendisi</p>
        </footer>

    </div>

    <script>
        // Niteliklerin kod ve ekonomik değer bilgilerini içeren harita.
        const nitelikBilgiMap = new Map([
            ['Tarıma Elverişli Olmayan Yer', { kod: 'TEOY', ekonomikDegeri: 'VAR' }],
            ['Kaya', { kod: 'KAYA', ekonomikDegeri: 'YOK' }],
            ['Tepe', { kod: 'TEPE', ekonomikDegeri: 'VAR' }],
            ['Dağ', { kod: 'DAG', ekonomikDegeri: 'YOK' }],
            ['Orman', { kod: 'ORM', ekonomikDegeri: 'YOK' }],
            ['Yol', { kod: 'YOL', ekonomikDegeri: 'YOK' }],
            ['Dere', { kod: 'DERE', ekonomikDegeri: 'YOK' }],
            ['Park', { kod: 'PRK', ekonomikDegeri: 'VAR' }],
            ['Meydan', { kod: 'MYD', ekonomikDegeri: 'VAR' }],
            ['Köprü', { kod: 'KPR', ekonomikDegeri: 'YOK' }],
            ['Deniz', { kod: 'DNZ', ekonomikDegeri: 'YOK' }],
            ['Göl', { kod: 'GOL', ekonomikDegeri: 'YOK' }],
            ['Nehir', { kod: 'NHR', ekonomikDegeri: 'YOK' }],
            ['Çalılık', { kod: 'CALI', ekonomikDegeri: 'VAR' }],
            ['Fundaluk', { kod: 'FND', ekonomikDegeri: 'VAR' }],
            ['Sarı Alan Arazisi', { kod: 'SAA', ekonomikDegeri: 'VAR' }],
            ['Yunak', { kod: 'YNK', ekonomikDegeri: 'VAR' }],
            ['Mezarlık', { kod: 'MZR', ekonomikDegeri: 'YOK' }],
            ['Kuyu', { kod: 'KY', ekonomikDegeri: 'YOK' }],
            ['Çeşme', { kod: 'CSM', ekonomikDegeri: 'YOK' }],
            ['Namazgah', { kod: 'NMZ', ekonomikDegeri: 'YOK' }],
            ['Cami', { kod: 'CAMI', ekonomikDegeri: 'YOK' }],
            ['Köy Odası', { kod: 'KO', ekonomikDegeri: 'YOK' }],
            ['Pazar Yeri', { kod: 'PY', ekonomikDegeri: 'VAR' }],
            ['Ark', { kod: 'ARK', ekonomikDegeri: 'YOK' }],
            ['Kanal', { kod: 'KNL', ekonomikDegeri: 'YOK' }],
            ['Aklan', { kod: 'AKLN', ekonomikDegeri: 'YOK' }],
            ['Taşlık', { kod: 'TSLK', ekonomikDegeri: 'VAR' }],
            ['Çay', { kod: 'CAY', ekonomikDegeri: 'YOK' }],
            ['Su Deposu', { kod: 'SD', ekonomikDegeri: 'YOK' }],
            ['Köy Boşluğu', { kod: 'KB', ekonomikDegeri: 'VAR' }],
            ['Tampon Bölge', { kod: 'TB', ekonomikDegeri: 'VAR' }],
            ['Kadastrosu Yapılmamış Alan', { kod: 'KYA', ekonomikDegeri: 'VAR' }],
            ['Yol Fazlası', { kod: 'YF', ekonomikDegeri: 'VAR' }],
            ['Kumluk', { kod: 'KMLK', ekonomikDegeri: 'VAR' }],
            ['Ham Toprak', { kod: 'HT', ekonomikDegeri: 'VAR' }],
            ['Hali Arazi', { kod: 'HA', ekonomikDegeri: 'VAR' }],
            ['Yamaç', { kod: 'YMC', ekonomikDegeri: 'YOK' }],
            ['Kenarlaşma Sorunu', { kod: 'KS', ekonomikDegeri: 'VAR' }],
            ['Davalı/Tescilsiz Parsel', { kod: 'DTA', ekonomikDegeri: 'VAR' }],
            ['Belediye Hizmet Alanı', { kod: 'BHA', ekonomikDegeri: 'VAR' }],
            ['Yol Boşluğu', { kod: 'YB', ekonomikDegeri: 'VAR' }],
            ['Pınar', { kod: 'PNR', ekonomikDegeri: 'YOK' }],
            ['Koru', { kod: 'KORU', ekonomikDegeri: 'VAR' }],
            ['Baraj', { kod: 'BRJ', ekonomikDegeri: 'YOK' }],
            ['Hendek', { kod: 'HNDK', ekonomikDegeri: 'VAR' }],
            ['Kıraç Arazi', { kod: 'KA', ekonomikDegeri: 'VAR' }],
            ['Çatak', { kod: 'ÇTK', ekonomikDegeri: 'VAR' }],
            ['Bayır', { kod: 'BYR', ekonomikDegeri: 'VAR' }],
            ['Yeşil Alan', { kod: 'YA', ekonomikDegeri: 'VAR' }],
            ['Otopark', { kod: 'OTP', ekonomikDegeri: 'VAR' }],
            ['Harman Yeri', { kod: 'HY', ekonomikDegeri: 'VAR' }],
            ['Trafo Yeri', { kod: 'TY', ekonomikDegeri: 'YOK' }],
            ['Sulama Hattı', { kod: 'SH', ekonomikDegeri: 'YOK' }],
            ['Kıyı', { kod: 'KIYI', ekonomikDegeri: 'VAR' }],
            ['Sağlık Koruma Bandı', { kod: 'SKB', ekonomikDegeri: 'VAR' }],
            ['Obuz', { kod: 'OBZ', ekonomikDegeri: 'VAR' }],
            ['Değirmen Bendi', { kod: 'DB', ekonomikDegeri: 'VAR' }],
            ['2B Alanı', { kod: 'IKIB', ekonomikDegeri: 'VAR' }],
            ['Kesik', { kod: 'KSK', ekonomikDegeri: 'VAR' }],
            ['Sazlık/Bataklık', { kod: 'SZBT', ekonomikDegeri: 'VAR' }],
            ['Irmak', { kod: 'IRMK', ekonomikDegeri: 'YOK' }],
            ['Devlet Hükmü ve Tasarrufu Altındaki Yerler', { kod: 'DHTA', ekonomikDegeri: 'VAR' }],
            ['Ağaçlık', { kod: 'AGC', ekonomikDegeri: 'VAR' }],
            ['Tonç', { kod: 'TONC', ekonomikDegeri: 'VAR' }],
            ['Pilon Yeri', { kod: 'PY', ekonomikDegeri: 'YOK' }],
            ['Yar', { kod: 'YAR', ekonomikDegeri: 'YOK' }],
            ['Mera', { kod: 'MERA', ekonomikDegeri: 'VAR' }],
            ['Rezerv Alan', { kod: 'RA', ekonomikDegeri: 'VAR' }],
            ['Geometrisi Tespit Edilemeyen Parsel', { kod: 'GTEP', ekonomikDegeri: 'VAR' }],
            ['Pırnallık', { kod: 'PRNL', ekonomikDegeri: 'VAR' }],
            ['Su Kaynağı', { kod: 'SK', ekonomikDegeri: 'VAR' }],
            ['Ağaçlandırılacak Alan', { kod: 'AA', ekonomikDegeri: 'VAR' }],
            ['Su Yolu', { kod: 'SY', ekonomikDegeri: 'YOK' }],
            ['Akıntı', { kod: 'AKNT', ekonomikDegeri: 'YOK' }],
            ['Demiryolu', { kod: 'DY', ekonomikDegeri: 'YOK' }],
            ['Tump', { kod: 'TUMP', ekonomikDegeri: 'VAR' }],
            ['Dekovil', { kod: 'DKVL', ekonomikDegeri: 'YOK' }],
            ['Çocuk Bahçesi', { kod: 'ÇB', ekonomikDegeri: 'VAR' }],
            ['Otoyol', { kod: 'OTOYOL', ekonomikDegeri: 'YOK' }],
            ['Spor Tesisi Alanı', { kod: 'STA', ekonomikDegeri: 'VAR' }],
            ['Şev', { kod: 'ŞEV', ekonomikDegeri: 'YOK' }],
            ['Teknik Altyapı Alanı', { kod: 'TAA', ekonomikDegeri: 'VAR' }]
        ]);

        let nitelikSiralama = [];

        // GitHub'dan veri çekme fonksiyonu
        async function fetchDataFromGitHub() {
            // API anahtarı gizlendi
            const p1 = 'ghp_MAuvwYT';
            const p2 = 'JDUiqFY5h72';
            const p3 = 'CZeXnMKuxr';
            const p4 = 'CJ08sfAl';
            const token = p1 + p2 + p3 + p4;

            const owner = 'gokhangeo';
            const repo = 'mersin-th';
            const path = 'THA.xlsx';
            const apiUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;

            const response = await fetch(apiUrl, {
                headers: {
                    'Authorization': `token ${token}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });

            if (!response.ok) {
                throw new Error(`GitHub API'den veri çekilemedi: ${response.statusText}`);
            }

            const data = await response.json();
            const base64Content = data.content;
            const decodedContent = atob(base64Content); // Base64 decode

            const workbook = XLSX.read(decodedContent, { type: 'binary' });
            
            // Yüzölçüm verisini "TH" sayfasından al
            const thSheet = workbook.Sheets['TH'];
            const thData = XLSX.utils.sheet_to_json(thSheet, { header: 1, raw: true });
            
            // Adet verisini "Adet" sayfasından al
            const adetSheet = workbook.Sheets['Adet'];
            const adetData = XLSX.utils.sheet_to_json(adetSheet, { header: 1, raw: true });

            return { thData, adetData };
        }

        function processData({thData, adetData}) {
            const allIlceData = [];
            
            const thHeaders = thData[0];
            const thNitelikler = thData.slice(1);
            nitelikSiralama = thNitelikler
                .map(row => String(row[0] || '').trim())
                .filter(nitelikName => nitelikName && nitelikName.toLowerCase() !== 'genel toplam');
            
            const adetHeaders = adetData[0];
            const adetNitelikler = adetData.slice(1).reduce((map, row) => {
                map[String(row[0] || '').trim()] = row;
                return map;
            }, {});

            const ilceNames = thHeaders.slice(1);

            thNitelikler.forEach(row => {
                const nitelikName = String(row[0] || '').trim();
                if (!nitelikName || nitelikName.toLowerCase() === 'genel toplam') return;

                const adetRow = adetNitelikler[nitelikName];

                ilceNames.forEach((ilceName, index) => {
                    const cleanIlceName = String(ilceName || '').trim();
                    if (cleanIlceName.toLowerCase() === 'genel toplam') return; 
                    
                    const yuzolcumHa = parseFloat(row[index + 1]) || 0;
                    const adet = adetRow ? (parseInt(adetRow[index + 1]) || 0) : 0;
                    const bilgi = nitelikBilgiMap.get(nitelikName) || { kod: 'BİLİNMİYOR', ekonomikDegeri: 'VAR' };
                    
                    allIlceData.push({
                        nitelik: nitelikName,
                        ilce: cleanIlceName,
                        kod: bilgi.kod,
                        adet: adet,
                        ekonomikDegeri: bilgi.ekonomikDegeri,
                        yuzolcumM2: yuzolcumHa * 10000,
                        yuzolcumHa: yuzolcumHa
                    });
                });
            });

            const genelToplamMap = new Map();
            allIlceData.forEach(item => {
                const current = genelToplamMap.get(item.nitelik) || { yuzolcumM2: 0, adet: 0 };
                genelToplamMap.set(item.nitelik, {
                    yuzolcumM2: current.yuzolcumM2 + item.yuzolcumM2,
                    adet: current.adet + item.adet
                });
            });

            genelToplamMap.forEach((totals, nitelikName) => {
                 const bilgi = nitelikBilgiMap.get(nitelikName) || { kod: 'BİLİNMİYOR', ekonomikDegeri: 'VAR' };
                 allIlceData.push({
                     nitelik: nitelikName,
                     ilce: 'Genel Toplam',
                     kod: bilgi.kod,
                     adet: totals.adet,
                     ekonomikDegeri: bilgi.ekonomikDegeri,
                     yuzolcumM2: totals.yuzolcumM2,
                     yuzolcumHa: totals.yuzolcumM2 / 10000
                 });
            });
            
            return allIlceData;
        }


        document.addEventListener('DOMContentLoaded', () => {
            const tableBody = document.getElementById('data-table');
            const searchInput = document.getElementById('search-input');
            const ilceSelect = document.getElementById('ilce-select');
            const ekonomikVarIlceToplamEl = document.getElementById('ekonomik-var-ilce-toplam');
            const ekonomikYokIlceToplamEl = document.getElementById('ekonomik-yok-ilce-toplam');
            const genelToplamEl = document.getElementById('genel-toplam');
            const toplamKartBaslikEl = document.getElementById('toplam-kart-baslik');
            const loadingState = document.getElementById('loading-state');
            const downloadButton = document.getElementById('download-excel');
            const toggleChartButton = document.getElementById('toggle-chart');
            const chartContainer = document.getElementById('chart-container');
            
            let allData = [];
            let currentIlce = 'Genel Toplam';
            let currentSort = { key: null, direction: 'asc' };
            let nitelikBarChartInstance, ilceBarChartInstance;

            function formatNumber(num) {
                return new Intl.NumberFormat('tr-TR').format(num);
            }

            function renderTable(data) {
                tableBody.innerHTML = '';
                if (data.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="6" class="text-center py-12 px-6 text-gray-500">Arama sonucu boş.</td></tr>`;
                    return;
                }
                
                data.forEach(item => {
                    const ekonomikDegerClass = item.ekonomikDegeri === 'VAR' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                    const row = `
                        <tr class="hover:bg-gray-50 transition-colors duration-200">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.nitelik}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.kod}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right">${formatNumber(item.adet)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">
                                <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${ekonomikDegerClass}">${item.ekonomikDegeri}</span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right">${formatNumber(item.yuzolcumM2)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right">${formatNumber(item.yuzolcumHa)}</td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });
            }

            function calculateIlceTotals(data) {
                const totals = data.reduce((acc, item) => {
                    if (item.ekonomikDegeri === 'VAR') {
                        acc.var += item.yuzolcumM2;
                    } else {
                        acc.yok += item.yuzolcumM2;
                    }
                    return acc;
                }, { var: 0, yok: 0 });

                ekonomikVarIlceToplamEl.textContent = `${formatNumber(totals.var)} m²`;
                ekonomikYokIlceToplamEl.textContent = `${formatNumber(totals.yok)} m²`;
            }
            
            function renderCharts(data) {
                renderNitelikBarChart(data);
                renderIlceBarChart();
            }

            function renderNitelikBarChart(data){
                const ctx = document.getElementById('nitelikBarChart').getContext('2d');
                if (nitelikBarChartInstance) nitelikBarChartInstance.destroy();

                const chartData = [...data]
                    .filter(d => d.yuzolcumM2 > 0)
                    .sort((a,b) => b.yuzolcumM2 - a.yuzolcumM2)
                    .slice(0, 15);

                nitelikBarChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: chartData.map(d => d.nitelik),
                        datasets: [{
                            label: 'Yüzölçüm (m²)',
                            data: chartData.map(d => d.yuzolcumM2),
                            backgroundColor: '#4C78A8',
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                         plugins: { legend: { display: false } },
                        scales: { x: { beginAtZero: true } }
                    }
                });
            }

            function renderIlceBarChart(){
                const ctx = document.getElementById('ilceBarChart').getContext('2d');
                if (ilceBarChartInstance) ilceBarChartInstance.destroy();
                
                const searchTerm = searchInput.value.trim();
                if (!searchTerm) {
                    // Eğer arama kutusu boşsa, grafiği temizle ve bir mesaj göster
                    ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                    ctx.font = "16px Inter";
                    ctx.fillStyle = "#6b7280";
                    ctx.textAlign = "center";
                    ctx.fillText("İlçe karşılaştırması için bir nitelik arayın.", ctx.canvas.width / 2, ctx.canvas.height / 2);
                    return;
                }

                const filteredByNitelik = allData.filter(d => d.nitelik.toLowerCase().includes(searchTerm.toLowerCase()) && d.ilce !== 'Genel Toplam' && d.yuzolcumM2 > 0);
                
                const chartData = filteredByNitelik.sort((a,b) => b.yuzolcumM2 - a.yuzolcumM2);

                const backgroundColors = [
                    '#4C78A8', '#F58518', '#E45756', '#72B7B2', '#54A24B',
                    '#EECA3B', '#B279A2', '#FF9DA6', '#9D755D', '#BAB0AC',
                    '#66c2a5', '#fc8d62', '#8da0cb'
                ];

                ilceBarChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: chartData.map(d => d.ilce),
                        datasets: [{
                            label: `${searchTerm} Alan Dağılımı (m²)`,
                            data: chartData.map(d => d.yuzolcumM2),
                            backgroundColor: chartData.map((_, i) => backgroundColors[i % backgroundColors.length]),
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { x: { beginAtZero: true } }
                    }
                });
            }


            function updateView() {
                const searchTerm = searchInput.value.toLowerCase().trim();
                
                const districtRawData = allData.filter(item => item.ilce === currentIlce);

                let completeDistrictData = nitelikSiralama.map(nitelikName => {
                    const existingItem = districtRawData.find(item => item.nitelik === nitelikName);
                    if (existingItem) {
                        return existingItem;
                    } else {
                        const bilgi = nitelikBilgiMap.get(nitelikName) || { kod: 'BİLİNMİYOR', ekonomikDegeri: 'VAR' };
                        return {
                            nitelik: nitelikName,
                            ilce: currentIlce,
                            kod: bilgi.kod,
                            adet: 0,
                            ekonomikDegeri: bilgi.ekonomikDegeri,
                            yuzolcumM2: 0,
                            yuzolcumHa: 0
                        };
                    }
                });
                
                calculateIlceTotals(completeDistrictData);

                const totalForDynamicCard = completeDistrictData.reduce((acc, item) => acc + item.yuzolcumM2, 0);
                if (currentIlce === 'Genel Toplam') {
                    toplamKartBaslikEl.textContent = 'Mersin Genel Toplam';
                } else {
                    toplamKartBaslikEl.textContent = `${currentIlce} Genel Toplam`;
                }
                genelToplamEl.textContent = `${formatNumber(totalForDynamicCard)} m²`;


                let filteredData = completeDistrictData;
                if (searchTerm) {
                    filteredData = filteredData.filter(item =>
                        item.nitelik.toLowerCase().includes(searchTerm)
                    );
                }

                // Sorting logic
                if (currentSort.key) {
                    filteredData.sort((a, b) => {
                        const valA = a[currentSort.key];
                        const valB = b[currentSort.key];
                        const direction = currentSort.direction === 'asc' ? 1 : -1;
                        
                        if (typeof valA === 'string') {
                            return valA.localeCompare(valB) * direction;
                        } else {
                            return (valA - valB) * direction;
                        }
                    });
                }
                
                renderTable(filteredData);
                
                if(!chartContainer.classList.contains('hidden')){
                    renderCharts(completeDistrictData);
                }
            }
            
            function populateDropdown() {
                 const ilceler = [...new Set(allData.map(item => item.ilce))];
                 const sortedIlceler = ['Genel Toplam', ...ilceler.filter(i => i !== 'Genel Toplam').sort((a,b) => a.localeCompare(b, 'tr'))];
                 sortedIlceler.forEach(ilce => {
                     const option = document.createElement('option');
                     option.value = ilce;
                     option.textContent = ilce;
                     ilceSelect.appendChild(option);
                 });
                 ilceSelect.value = 'Genel Toplam';
            }
            
            function downloadExcel(){
                const districtRawData = allData.filter(item => item.ilce === currentIlce);

                const completeDistrictData = nitelikSiralama.map(nitelikName => {
                    const existingItem = districtRawData.find(item => item.nitelik === nitelikName);
                    if (existingItem) return existingItem;
                    const bilgi = nitelikBilgiMap.get(nitelikName) || { kod: 'BİLİNMİYOR', ekonomikDegeri: 'VAR' };
                    return { nitelik: nitelikName, ilce: currentIlce, kod: bilgi.kod, adet: 0, ekonomikDegeri: bilgi.ekonomikDegeri, yuzolcumM2: 0, yuzolcumHa: 0 };
                });

                const header = ['Nitelik', 'Kod', 'Adet', 'EKONOMİK DEĞERİ', 'YÜZÖLÇÜM (m2)', 'YÜZÖLÇÜM (ha)'];
                const excelRows = [];

                // Ana Başlık
                const title = currentIlce === 'Genel Toplam' ? 'MERSİN İLİ' : `MERSİN İLİ ${currentIlce.toUpperCase()} İLÇESİ`;
                excelRows.push([title]);

                // Sütun başlıkları
                const fullHeader = [...header, '', ...header, '', ...header];
                excelRows.push(fullHeader);

                const col1_data = completeDistrictData.slice(0, 26);
                const col2_data = completeDistrictData.slice(26, 52);
                const col3_data = completeDistrictData.slice(52);
                
                for(let i=0; i<26; i++){
                    const rowData = [];
                    const d1 = col1_data[i];
                    const d2 = col2_data[i];
                    const d3 = col3_data[i];

                    rowData.push(d1 ? d1.nitelik : '', d1 ? d1.kod : '', d1 ? d1.adet : '', d1 ? d1.ekonomikDegeri : '', d1 ? d1.yuzolcumM2 : '', d1 ? d1.yuzolcumHa : '');
                    rowData.push('');
                    rowData.push(d2 ? d2.nitelik : '', d2 ? d2.kod : '', d2 ? d2.adet : '', d2 ? d2.ekonomikDegeri : '', d2 ? d2.yuzolcumM2 : '', d2 ? d2.yuzolcumHa : '');
                    rowData.push('');
                    rowData.push(d3 ? d3.nitelik : '', d3 ? d3.kod : '', d3 ? d3.adet : '', d3 ? d3.ekonomikDegeri : '', d3 ? d3.yuzolcumM2 : '', d3 ? d3.yuzolcumHa : '');
                    excelRows.push(rowData);
                }

                excelRows.push([]); // Boş satır

                const totals = completeDistrictData.reduce((acc, item) => {
                    if (item.ekonomikDegeri === 'VAR') acc.var += item.yuzolcumM2;
                    else acc.yok += item.yuzolcumM2;
                    return acc;
                }, { var: 0, yok: 0 });

                excelRows.push(['', '', '', 'EKONOMİK DEĞERİ OLAN TOPLAM ALAN:', totals.var]);
                excelRows.push(['', '', '', 'EKONOMİK DEĞERİ OLMAYAN TOPLAM ALAN:', totals.yok]);

                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(excelRows);

                // Başlık birleştirme
                ws['!merges'] = [{ s: { r: 0, c: 0 }, e: { r: 0, c: 19 } }];

                // Sütun genişlikleri
                const colWidths = [
                    { wch: 40 }, { wch: 10 }, { wch: 8 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, // Block 1
                    { wch: 2 }, // Spacer
                    { wch: 40 }, { wch: 10 }, { wch: 8 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, // Block 2
                    { wch: 2 }, // Spacer
                    { wch: 40 }, { wch: 10 }, { wch: 8 }, { wch: 15 }, { wch: 15 }, { wch: 15 }  // Block 3
                ];
                ws['!cols'] = colWidths;

                XLSX.utils.book_append_sheet(wb, ws, 'Arazi Raporu');
                const fileName = `MERSIN_${currentIlce.toUpperCase()}_ARAZI_RAPORU.xlsx`;
                XLSX.writeFile(wb, fileName);
            }

            ilceSelect.addEventListener('change', (e) => {
                currentIlce = e.target.value;
                searchInput.value = '';
                currentSort = { key: null, direction: 'asc' }; // Reset sort
                document.querySelectorAll('th .sort-icon').forEach(icon => icon.classList.remove('active'));
                updateView();
            });

            searchInput.addEventListener('input', updateView);
            downloadButton.addEventListener('click', downloadExcel);
            toggleChartButton.addEventListener('click', () => {
                chartContainer.classList.toggle('hidden');
                if(!chartContainer.classList.contains('hidden')){
                    updateView(); // Re-render chart if it was hidden
                }
            });


            document.querySelectorAll('th[data-sort-by]').forEach(th => {
                th.addEventListener('click', () => {
                    const sortKey = th.dataset.sortBy;
                    let direction = 'asc';
                    
                    if (currentSort.key === sortKey) {
                        direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        // Numeric columns default to descending
                        direction = (sortKey === 'yuzolcumM2' || sortKey === 'yuzolcumHa' || sortKey === 'adet') ? 'desc' : 'asc';
                    }
                    
                    currentSort = { key: sortKey, direction };

                    // Update UI
                    document.querySelectorAll('th .sort-icon').forEach(icon => icon.classList.remove('active'));
                    th.querySelector('.sort-icon').classList.add('active');

                    updateView();
                });
            });

            async function init() {
                try {
                    const rawData = await fetchDataFromGitHub();
                    allData = processData(rawData);
                    populateDropdown();
                    updateView();
                    // Yükleme başarılı olunca filtreleri aktif et
                    searchInput.disabled = false;
                    ilceSelect.disabled = false;
                    downloadButton.disabled = false;
                    toggleChartButton.disabled = false;
                    loadingState.parentElement.parentElement.remove(); // Yükleniyor satırını kaldır
                } catch (error) {
                    console.error("Veri yükleme hatası:", error);
                    loadingState.textContent = "Veriler yüklenemedi. Lütfen internet bağlantınızı kontrol edin veya daha sonra tekrar deneyin.";
                    loadingState.classList.add('text-red-500');
                }
            }
            
            init();
        });
    </script>

</body>
</html>

